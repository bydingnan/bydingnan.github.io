
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
  
  
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html"></a></h1>
  
    <h2></h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="index.html">Home</a></li>
  <li><a href="archives.html">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div class="blog-index">

	<article>
		 <header>
		  	<h1 class="entry-title"><a href="14700365720801.html">HDFS集群配置、搭建、备份</a></h1>
			<p class="meta"><time datetime="2016-08-01T15:29:32+08:00" 
			pubdate data-updated="true">2016/8/1</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<p>以实际情况为例，三台机器组成的集群， 系统为Ubuntu 16.04 server版</p>

<h2 id="toc_0">1 环境配置</h2>

<p>搭建了一个三台机器的集群：</p>

<pre><code class="language-shell">10.0.1.215  NameNode      talkmate  Talkmate123
10.0.1.217  DataNode1     talkmate  Talkmate123
10.0.1.219  DataNode2     talkmate  Talkmate123
</code></pre>

<p>以上三列分别为IP hostname 用户名 密码</p>

<h3 id="toc_1">1.1 修改hostname</h3>

<p>　　Hostname在<strong><code>/etc/hostname</code></strong>中修改，域名映射关系在<strong><code>/etc/hosts</code></strong>中修改，对于三台机器都需要修改。</p>

<h3 id="toc_2">1.2 打通NameNode到DataNode节点的SSH无密码登陆</h3>

<p>　　一般系统是默认安装了ssh命令的。如果没有，或者版本比较老，则可以重新安装：<br/>
 <code>sudo apt-get install ssh</code></p>

<pre><code class="language-shell">  cd ~/.ssh
  ssh-keygen –t rsa
  cat id_rsa.pub &gt; authorized_keys
</code></pre>

<p>　　至此可以测试一下ssh 本机IP是否需要密码，如果成功，说明本机配置成功。</p>

<h3 id="toc_3">1.3 将authorized_keys文件复制到所有DataNode节点</h3>

<pre><code class="language-shell">scp authorized_keys talkmate@DataNode1:/home/talkmate/.ssh/
scp authorized_keys talkmate@DataNode2:/home/talkmate/.ssh/
</code></pre>

<p>　　至此免密码登录配置完毕，可以通过本机ssh各个节点IP来测试是否需要密码登录。</p>

<h3 id="toc_4">1.4 下载Hadoop软件包，官方下载地址</h3>

<p><a href="http://mirrors.cnnic.cn/apache/hadoop/common/stable/">http://mirrors.cnnic.cn/apache/hadoop/common/stable/</a><br/><br/>
<a href="http://hadoop.apache.org/releases.html#Download">http://hadoop.apache.org/releases.html#Download</a></p>

<pre><code class="language-shell">tar zxvf hadoop-2.6.4.tar.gz
mv hadoop-2.6.4 /home/talkmate/softwares
</code></pre>

<h3 id="toc_5">1.5 配置环境变量</h3>

<pre><code class="language-shell">vim ~/.bash_profile

export JAVA_HOME=/home/talkmate/softwares/jdk1.8.0_91
export HADOOP_HOME=/home/talkmate/softwares/hadoop-2.6.4
export PATH=~/softwares/usr/bin:$JAVA_HOME/bin:$HADOOP_HOME/bin:$PATH
</code></pre>

<h2 id="toc_6">2 Hadoop配置文件</h2>

<h3 id="toc_7">2.1 相关文件</h3>

<p>在NameNode上修改hadoop配置文件<br/>
主要修改<strong><code>/home/talkmate/softwares/hadoop-2.6.4/etc/hadoop/</code></strong>目录下的配置文件</p>

<p><strong><code>hadoop-env.sh</code></strong>　　　Hadoop环境变量设置<br/><br/>
<strong><code>core-site.xml</code></strong>　　　NameNode、IP和端口设置、全局设置等<br/><br/>
<strong><code>hdfs-site.xml</code></strong>　　　HDFS数据块副本等具体参数<br/><br/>
<strong><code>mapred-site.xml</code></strong>　　MapReduce、jobhistory、框架设置<br/><br/>
<strong><code>yarn-env.sh</code></strong>　　　　Yarn环境变量设置<br/><br/>
<strong><code>yarn-site.xml</code></strong>　　　Yarn框架具体设置<br/><br/>
<strong><code>masters</code></strong>　　　　　　　主节点<br/><br/>
<strong><code>slaves</code></strong>　　　　　　　　从节点</p>

<h3 id="toc_8">2.2 core-site.xml</h3>

<pre><code class="language-xml">&lt;configuration&gt;
    &lt;property&gt;
        &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;
        &lt;value&gt;/home/talkmate/hdfs_data/tmp&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;fs.defaultFS&lt;/name&gt;
        &lt;value&gt;hdfs://NameNode:8020&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;io.file.buffer.size&lt;/name&gt;
        &lt;value&gt;131072&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;fs.trash.interval&lt;/name&gt;
        &lt;value&gt;10080&lt;/value&gt;
    &lt;/property&gt;
&lt;/configuration&gt;
</code></pre>

<h3 id="toc_9">2.3 hadoop-env.sh</h3>

<ul>
<li>将配置文件中的<strong><code>export HADOOP_CONF_DIR=${HADOOP_CONF_DIR:-&quot;/etc/hadoop&quot;}</code></strong>改为<br/>
<strong><code>export HADOOP_CONF_DIR=/home/talkmate/softwares/hadoop-2.6.4/etc/hadoop</code></strong><br/></li>
<li>增加JAVA_HOME<br/>
<strong><code>export JAVA_HOME=/home/talkmate/softwares/jdk1.8.0_91</code></strong></li>
</ul>

<h3 id="toc_10">2.4 yarn-env.sh</h3>

<ul>
<li>将配置文件中的<strong><code>export YARN_CONF_DIR=&quot;${YARN_CONF_DIR:-$HADOOP_YARN_HOME/conf}&quot;</code></strong>改为<br/>
<strong><code>export YARN_CONF_DIR=/home/talkmate/softwares/hadoop-2.6.4/etc/hadoop</code></strong><br/></li>
<li>增加JAVA_HOME<br/>
<strong><code>export JAVA_HOME=/home/talkmate/softwares/jdk1.8.0_91</code></strong></li>
</ul>

<h3 id="toc_11">2.5 hdfs-site.xml</h3>

<pre><code class="language-xml">&lt;configuration&gt;
    &lt;property&gt;
        &lt;name&gt;dfs.replication&lt;/name&gt;
        &lt;value&gt;3&lt;/value&gt;                                                                                                      
    &lt;/property&gt;                                                                                                          
    &lt;property&gt;
        &lt;name&gt;dfs.name.dir&lt;/name&gt;
        &lt;value&gt;/home/talkmate/hdfs_data/name&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;dfs.data.dir&lt;/name&gt;
        &lt;value&gt;/home/talkmate/hdfs_data/data&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;dfs.webhdfs.enabled&lt;/name&gt;
        &lt;value&gt;true&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;dfs.namenode.checkpoint.period&lt;/name&gt;
        &lt;value&gt;3600&lt;/value&gt;
        &lt;description&gt;The number of seconds between two periodic checkpoints.  &lt;/description&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;fs.checkpoint.size&lt;/name&gt;
        &lt;value&gt;67108864&lt;/value&gt;
        &lt;description&gt;The size of the current edit log (in bytes) that triggers a periodic checkpoint even if the fs.checkpoint.period hasn&#39;t expired.  
        &lt;/description&gt;
    &lt;/property&gt;

    &lt;property&gt;
        &lt;name&gt;dfs.namenode.checkpoint.dir&lt;/name&gt;
        &lt;value&gt;/home/talkmate/hdfs_data/checkpoint&lt;/value&gt;
        &lt;description&gt;Determines where on the local filesystem the DFS secondary name node should store the temporary images to merge. If this is a comma-delimited list of directories then the image is replicated in all of the directories for redundancy.  &lt;/description&gt;
    &lt;/property&gt;

    &lt;property&gt;
        &lt;name&gt;dfs.http.address&lt;/name&gt;
        &lt;value&gt;NameNode:50070&lt;/value&gt;
        &lt;description&gt;
            The address and the base port where the dfs namenode web ui will listen on.
            If the port is 0 then the server will start on a free port.
        &lt;/description&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;dfs.secondary.http.address&lt;/name&gt;
        &lt;value&gt;DataNode1:50090&lt;/value&gt;
        &lt;description&gt;NameNode get the newest fsimage via dfs.secondary.http.address&lt;/description&gt;
    &lt;/property&gt;
&lt;/configuration&gt;
</code></pre>

<h3 id="toc_12">2.6 mapred-site.xml</h3>

<pre><code class="language-xml">&lt;configuration&gt;
    &lt;property&gt;
        &lt;name&gt;mapreduce.framework.name&lt;/name&gt;
        &lt;value&gt;yarn&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt;
        &lt;value&gt;NameNode:10020&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt;
        &lt;value&gt;NameNode:19888&lt;/value&gt;
    &lt;/property&gt;
&lt;/configuration&gt;
</code></pre>

<h3 id="toc_13">2.7 yarn-site.xml</h3>

<pre><code class="language-xml">&lt;configuration&gt;
    &lt;property&gt;
        &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;
        &lt;value&gt;mapreduce_shuffle&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;yarn.nodemanager.aux-services.mapreduce.shuffle.class&lt;/name&gt;
        &lt;value&gt;org.apache.hadoop.mapred.ShuffleHandler&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;yarn.resourcemanager.address&lt;/name&gt;
        &lt;value&gt;NameNode:8032&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;yarn.resourcemanager.scheduler.address&lt;/name&gt;
        &lt;value&gt;NameNode:8030&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;yarn.resourcemanager.resource-tracker.address&lt;/name&gt;
        &lt;value&gt;NameNode:8031&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;yarn.resourcemanager.admin.address&lt;/name&gt;
        &lt;value&gt;NameNode:8033&lt;/value&gt;
    &lt;/property&gt;
    &lt;property&gt;
        &lt;name&gt;yarn.resourcemanager.webapp.address&lt;/name&gt;
        &lt;value&gt;NameNode:8088&lt;/value&gt;
    &lt;/property&gt;
&lt;/configuration&gt;
</code></pre>

<h3 id="toc_14">2.8 masters</h3>

<pre><code class="language-shell">NameNode
</code></pre>

<h3 id="toc_15">2.9 slaves</h3>

<pre><code class="language-shell">DataNode1
DataNode2
</code></pre>

<h2 id="toc_16">3 发布</h2>

<h2 id="toc_17">3.1 将NameNode节点配置好的Hadoop目录复制到每一个DataNode节点上</h2>

<p><strong><code>scp –r /home/talkmate/softwares/hadoop-2.6.4 DataNode1@:/home/talkmate/softwares/</code></strong><br/><br/>
<strong><code>scp –r /home/talkmate/softwares/hadoop-2.6.4 DataNode1@:/home/talkmate/softwares/</code></strong></p>

<h3 id="toc_18">3.2 在NameNode节点上格式化NameNode</h3>

<pre><code class="language-shell">hadoop namenode –format
</code></pre>

<h3 id="toc_19">3.3 执行</h3>

<p>运行</p>

<pre><code class="language-shel">sbin/start-all.sh
</code></pre>

<p>停止</p>

<pre><code class="language-shell">sbin/stop-all.sh
</code></pre>

<h3 id="toc_20">3.4 查看Hadoop工作情况</h3>

<p><strong><code>http://namenode:50070/</code></strong> :  主页<br/><br/>
<strong><code>http://namenode:8088/</code></strong>  :   jobs追踪页面<br/><br/>
<strong><code>hadoop dfsadmin -report</code></strong> : 集群状态<br/><br/>
<strong><code>jps</code></strong> : 节点工作情况，按目前的配置状况，正常情况应该是：</p>

<p>NameNode   </p>

<pre><code class="language-shell">16656 NameNode
17347 Application
21546 Jps
10491 JobHistoryServer
3870 SecondaryNameNode
15727 ResourceManager
</code></pre>

<p>DataNode1</p>

<pre><code class="language-shell">6706 Jps
32658 DataNode
437 NodeManager
319 SecondaryNameNode
</code></pre>

<p>DataNode2</p>

<pre><code class="language-shell">2675 NodeManager
21124 Jps
2543 DataNode
</code></pre>

<h2 id="toc_21">4 备份</h2>

<h3 id="toc_22">4.1 相关配置</h3>

<p>已经在配置文件中配置了相关字段:<br/><br/>
<strong><code>dfs.replication</code></strong> : 每个记录保存3份<br/><br/>
<strong><code>dfs.namenode.checkpoint.dir</code></strong>: checkpoint保存文件夹，恢复数据用<br/><br/>
<strong><code>dfs.secondary.http.address</code></strong> :  secondary节点位置</p>

<h3 id="toc_23">4.2 恢复：</h3>

<p>　　若是DataNode丢失，hadoop在数据被再次使用时进行检查，如果发现少了一个备份，会进行数据恢复工作。也就是说，数据恢复是自动，这也是hadoop的强大之处。  </p>

<ul>
<li>至于NameNode的恢复，在非NameNode节点上，保存一个日志镜像secondaryNnameNode。若NameNode出现问题，将secondary namenode 存储的checkpoint数据copy到NameNode上，进行导入恢复。<br/></li>
</ul>

<pre><code class="language-shell">scp -r talkmate@DataNode1:/home/talkmate/hdfs_data/checkpoint/ .
</code></pre>

<ul>
<li>kill掉DataNode进程</li>
</ul>

<pre><code class="language-shell">jps
</code></pre>

<ul>
<li>删除name目录下的所有内容，但是必须保证name这个目录是存在的，然后进行恢复</li>
</ul>

<pre><code class="language-shell">hadoop namenode -importCheckpoint  
</code></pre>

<p>正常启动以后，屏幕上会显示很多log，这个时候namenode就可以正常访问了 </p>

<ul>
<li>检查文件Block的完整性 </li>
</ul>

<pre><code class="language-shell">hadoop fsck /

</code></pre>

<ul>
<li><p>如果是HEALTHY，停止namenode，使用crrl+C或者会话结束 </p></li>
<li><p>down掉的节点经过恢复后，可以直接链接进入hadoop集群，而不用重新启动集群。命令是  </p></li>
</ul>

<pre><code class="language-shell">sbin/hadoop-daemon.sh start namenode
</code></pre>


		</div>

		

	</article>
 
	<article>
		 <header>
		  	<h1 class="entry-title"><a href="14700365205842.html">Flume配置方案、源码修改</a></h1>
			<p class="meta"><time datetime="2016-08-01T15:28:40+08:00" 
			pubdate data-updated="true">2016/8/1</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<h1 id="toc_0">一 配置</h1>

<h2 id="toc_1">1.1 client端</h2>

<p>client端采用avro-client的方式，定时向server发送数据，并附送headerFile，目前看这种方式更灵活，也符合数据业务的需求。</p>

<p><strong>运行demo</strong></p>

<pre><code class="language-shell">export JAVA_HOME=/home/talkmate/softwares/jdk1.8.0_91

dir_array=(UserRegister UserLogin UserPasswordForgot UserCourseBuy) 

for dir in ${dir_array[@]}
do
    if [ -d /home/talkmate/Deploy/daily_log/data/$dir ];then
        rm /home/talkmate/Deploy/daily_log/data/$dir/*.COMPLETED
        ./bin/flume-ng avro-client -H localhost -p 44444 --dirname /home/talkmate/Deploy/daily_log/data/$dir --headerFile header/$dir -D    flume.root.logger=DEBUG,console --conf conf
        sleep 2
    fi
done
</code></pre>

<p><strong>headerFile demo</strong></p>

<p>header/CourseInfo</p>

<pre><code class="language-shell">field=CourseInfo
</code></pre>

<p><strong>conf/flume-env.sh</strong>  </p>

<p>Java默认GC为20M 不设置此选项会导致内存频繁溢出，conf路径要包含在 --conf 选项中</p>

<pre><code class="language-shell">26 export JAVA_OPTS=&quot;-Xms2048m -Xmx3072m -Xss256k -Xmn2g -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit&quot;
</code></pre>

<h2 id="toc_2">1.2 server端</h2>

<p>接收端采用的是avro source、file channel和hdfs sink，具体配置如下</p>

<pre><code class="language-shell">#初始化
agent1.sources = source_db
agent1.sinks = sink_CourseInfo
agent1.channels = channel_CourseInfo

#配置source
agent1.sources.source_db.type = avro
agent1.sources.source_db.bind = localhost
agent1.sources.source_db.port = 55555
agent1.sources.source_db.channels = channel_CourseInfo

#根据头文件信息分发数据
agent1.sources.source_db.selector.type = multiplexing
agent1.sources.source_db.selector.header = field
agent1.sources.source_db.selector.mapping.CourseInfo = channel_CourseInfo
agent1.sources.source_db.selector.mapping.CourseInfoDetail = channel_CourseInfoDetail

#hdfs sink
agent1.sinks.sink_CourseInfo.type = hdfs
agent1.sinks.sink_CourseInfo.hdfs.path = hdfs://NameNode:8020/talkmate/db/course_info
agent1.sinks.sink_CourseInfo.hdfs.rollInterval = 0
agent1.sinks.sink_CourseInfo.hdfs.fileType = DataStream
agent1.sinks.sink_CourseInfo.hdfs.rollSize = 50000000
agent1.sinks.sink_CourseInfo.hdfs.batchSize = 2000
agent1.sinks.sink_CourseInfo.hdfs.rollCount = 100000
agent1.sinks.sink_CourseInfo.hdfs.useLocalTimeStamp = true
agent1.sinks.sink_CourseInfo.hdfs.writeFormat = Text
agent1.sinks.sink_CourseInfo.hdfs.filePrefix = course_info
agent1.sinks.sink_CourseInfo.hdfs.inUseSuffix = .tmp
agent1.sinks.sink_CourseInfo.hdfs.idleTimeout = 30

#file channel
agent1.channels.channel_CourseInfo.type = file
agent1.channels.channel_CourseInfo.checkpointDir = /home/talkmate/Deploy/fchannel/CourseInfo/checkpoint
agent1.channels.channel_CourseInfo.dataDirs = /home/talkmate/Deploy/fchannel/CourseInfo/data
agent1.channels.channel_CourseInfo.capacity = 1000000
agent1.channels.channel_CourseInfo.keep-alive = 30
agent1.channels.channel_CourseInfo.transactionCapacity = 2000
agent1.channels.channel_CourseInfo.write-timeout = 30
agent1.channels.channel_CourseInfo.checkpoint-timeout=600

#bind sink to channel
agent1.sinks.sink_CourseInfo.channel = channel_CourseInfo
</code></pre>

<p><strong>说明</strong>  </p>

<ul>
<li>一个event就是一条数据<br/></li>
<li>batchSize flush的event数量<br/></li>
<li>rollSize 文件滚动的最大上限<br/></li>
<li>rollCount 文件滚动的最大event数量<br/></li>
<li>idleTimeout 若无写事件，在改时间(s)后关闭文件<br/></li>
<li>capacity 越大越好，小了会内存溢出<br/></li>
<li>transactionCapacity 和 batchSize 最好一样大<br/></li>
</ul>

<p><strong>启动服务</strong>  </p>

<pre><code class="language-shell">/bin/flume-ng agent -n agent1 -c ./conf -f ./conf/hdfs_server.conf  &gt; logs/runtime.log 2&gt;&amp;1
</code></pre>

<h1 id="toc_3">二 源码修改</h1>

<h2 id="toc_4">2.1 解决乱码后传输中断问题</h2>

<p>文件：<code>flume-ng-core/src/main/java/org/apache/flume/serialization/ResettableFileInputStream.java</code><br/><br/>
函数：<code>readChar()</code>  </p>

<pre><code class="language-java">216     } else {
217         if(isEndOfInput) {
218             incrPosition(delta, false);
219             logger.info(&quot;End of File.&quot;);
220             return -1;//end of file
221         } else{
222             incrPosition(1, false);
223             buf.clear();
224             buf.flip();
225             refillBuf();
226             logger.warn(&quot;May have special characters.&quot;);
227             return 32;//a partial character of space
228         }
229     }
</code></pre>

<p>检测到异常字符不是退出，而是返回一个空格(32 的Ascii）</p>

<h2 id="toc_5">2.2 解决数据单行字符长度过长导致的被截断成两行的问题</h2>

<p>文件：<code>flume-ng-core/src/main/java/org/apache/flume/serialization/LineDeserializer.java</code><br/><br/>
变量：<code>MAXLINE_DFLT</code></p>

<pre><code class="language-java">53   public static final int MAXLINE_DFLT = 20480;
</code></pre>

<h2 id="toc_6">2.3 HDFS sink的文件滚动配置不生效问题</h2>

<p>文件：<code>flume-ng-sinks/flume-hdfs-sink/src/main/java/org/apache/flume/sink/hdfs/AbstractHDFSWriter.java</code><br/><br/>
函数：<code>isUnderReplicated()</code></p>

<pre><code class="language-java">82   public boolean isUnderReplicated() {
83     try {
84       int numBlocks = getNumCurrentReplicas();
85       if (numBlocks == -1) {
86         return false;
87       }
88       int desiredBlocks;
89       if (configuredMinReplicas != null) {
90         desiredBlocks = configuredMinReplicas;
91       } else {
92         desiredBlocks = getFsDesiredReplication();
93       }
94       return false;
95       //return numBlocks &lt; desiredBlocks;
</code></pre>

<h2 id="toc_7">2.3 自定义HDFS文件后缀的Index</h2>

<p>文件：<code>flume-ng-sinks/flume-hdfs-sink/src/main/java/org/apache/flume/sink/hdfs/BucketWriter.java</code></p>

<pre><code class="language-java">117   AtomicInteger renameTries = new AtomicInteger(0);
</code></pre>

<h2 id="toc_8">2.4 avro-client 参数设置</h2>

<p>文件：<code>flume-ng-core/src/main/java/org/apache/flume/client/avro/AvroCLIClient.java</code></p>

<pre><code class="language-java">56   private static final int BATCH_SIZE = 200;
57   private static final int MAX_LINE_LENGTH = 20480;
</code></pre>

<h2 id="toc_9">2.5 时间戳解析优化</h2>

<p>文件：<code>flume-ng-sinks/flume-hdfs-sink/src/main/java/org/apache/flume/sink/hdfs/HDFSEventSink.java</code>  </p>

<p>import</p>

<pre><code class="language-java">33 import java.text.SimpleDateFormat;
</code></pre>

<p>定义两个时间变量</p>

<pre><code class="language-java">144     private SimpleDateFormat sdfPath = null;        //for file in hdfs path
145     private SimpleDateFormat sdfName = null;        //for file name prefix
</code></pre>

<p>configure函数</p>

<pre><code class="language-java">206     filePathFormat =  context.getString(&quot;hdfs.path.format&quot;, &quot;yyyyMMdd&quot;);        //time&#39;s format ps:&quot;yyyy-MM-dd&quot;
207     sdfPath = new SimpleDateFormat(filePathFormat);
208
209     fileName = context.getString(&quot;hdfs.filePrefix&quot;, defaultFileName);
210     fileNameFormat = context.getString(&quot;hdfs.filePrefix.format&quot;, &quot;HHmm&quot;);
211     sdfName = new SimpleDateFormat(fileNameFormat);
212
213     addSaveTime = context.getBoolean(&quot;hdfs.addSaveTime&quot;, false);     //是否在hdfs文件中加入小时
</code></pre>

<p>增加获取时间格式函数</p>

<pre><code class="language-java">376   public String getTime(String type, long timestamp) {
377       String time = &quot;&quot;;
378       if(type.equals(&quot;name&quot;))
379           time = sdfName.format(timestamp);
380       else if(type.equals(&quot;path&quot;))
381           time = sdfPath.format(timestamp);
382       return time;
383   }
</code></pre>

<p>process()函数 修改重命名bucket</p>

<pre><code class="language-java">411         String realPath = filePath;
412         String realName = fileName;
413         realPath += DIRECTORY_DELIMITER + getTime(&quot;path&quot;, System.currentTimeMillis());
414         if (addSaveTime) {
415             realName += &quot;.&quot; + getTime(&quot;name&quot;, System.currentTimeMillis());
416         }
</code></pre>

<h2 id="toc_10">2.6 编译</h2>

<pre><code class="language-shell">mvn install -DskipTests -Dtar
</code></pre>

<p>生成结果</p>

<pre><code class="language-shell">apache-flume-1.6.0-src/flume-ng-dist/target/
</code></pre>

<h1 id="toc_11">三 部署脚本</h1>

<h2 id="toc_12">3.1 daily_log</h2>

<pre><code class="language-shell"> 20 scp dingnan@test.200h.com:/var/log/daily_log/last_timestamp .
 21 saved_timestamp=`cat saved_timestamp`
 22 last_timestamp=`cat last_timestamp`
 23 categary_map=()
 24 dir_map=()
 25
 26 if [ $last_timestamp -gt $saved_timestamp ];then
 27     scp dingnan@test.200h.com:/var/log/daily_log/*$last_timestamp* raw_data/
 28     #更新timestamp
 29     echo $last_timestamp &gt; saved_timestamp
 30 fi
 31
 32 index=0
 33 for line in `cat mapping_file`
 34 do
 35     categary=`echo $line | cut -d &quot;_&quot; -f 1,2`
 36     dir_name=`echo $line | cut -d &quot;_&quot; -f 3`
 37     categary_map[$index]=$categary
 38     dir_map[$index]=$dir_name
 39     ((index++))
 40 done
 41
 42 #parse
 43 for file_name in `ls raw_data`
 44 do
 45     categary=`echo $file_name | cut -d &quot;_&quot; -f 1,2`
 46     index=0
 47     for cate in ${categary_map[@]}
 48     do
 49         if [ &quot;$cate&quot; == &quot;$categary&quot; ];then
 50             path=data/${dir_map[$index]}
 51
 52             if [ ! -d $path ];then
 53                 mkdir -p $path
 54             fi
 55             sed &#39;s/\[\^A\]/\t/g&#39; raw_data/$file_name &gt; $path/$file_name
 56             break
 57         else
 58             ((index++))
 59         fi
 60     done
 61 done
</code></pre>

<p>如要解决ssh连接访问慢的问题，在ssh连接的一方，配置中关闭GSSAPIAuthentication  </p>

<p>/etc/ssh/ssh_config</p>

<pre><code class="language-shell">GSSAPIAuthentication no
</code></pre>


		</div>

		

	</article>
 
	<article>
		 <header>
		  	<h1 class="entry-title"><a href="14700364668003.html">基于HTK的孤立词无监督识别</a></h1>
			<p class="meta"><time datetime="2016-08-01T15:27:46+08:00" 
			pubdate data-updated="true">2016/8/1</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<blockquote>
<p>训练一个模型，通过发音音素识别</p>
</blockquote>

<p>先整体介绍一下语音的识别流程  </p>

<p>总的目的是这样：</p>

<p><img src="http://10.0.1.215/markdown/htk_unsupervised_1" alt=""/></p>

<p>语音文件需要预处理：</p>

<p><img src="http://10.0.1.215/markdown/htk_unsupervised_2" alt=""/></p>

<p>可能用到的文件：</p>

<ul>
<li>HTK安装包</li>
</ul>

<pre><code class="language-shell">wget http://10.0.1.215/htk/HTK-3.4.1.tar.gz
</code></pre>

<ul>
<li>htkbook</li>
</ul>

<pre><code class="language-shell">wget http://10.0.1.215/htk/htkbook.pdf.gz
</code></pre>

<ul>
<li>字典文件</li>
</ul>

<pre><code class="language-shell">wget http://10.0.1.215/htk/dict.tar.gz
</code></pre>

<ul>
<li>脚本文件</li>
</ul>

<pre><code class="language-shell">wget http://10.0.1.215/htk/scripts.tar.gz
</code></pre>

<ul>
<li>录音文件：</li>
</ul>

<pre><code class="language-shell">wget http://10.0.1.215/htk/trainspeech.tar.gz
wget http://10.0.1.215/htk/testspeech.tar.gz
</code></pre>

<h2 id="toc_0">一、准备训练语音文件</h2>

<h3 id="toc_1">1 安装音频录放工具“sox”</h3>

<p>&quot;sox&quot;主要包含两个命令，后续将会用到：rec（录音）和play（播放）</p>

<pre><code class="language-shell">sudo apt-get install sox
</code></pre>

<h3 id="toc_2">2 创建目录树</h3>

<p>为了有序组织各种中间文件，在创建如图所示目录树：</p>

<pre><code class="language-shell">mkdir -p htk_color/{config,data/{test/{mfc,speech},train/{mfc,speech}},dict,hmm0,hmm1,hmm2,hmm3,hmm4,hmm5,hmm6,hmm7,labels,lists,results,scripts}
</code></pre>

<h3 id="toc_3">3 录制“训练语音文件”</h3>

<p>cd htk_color；（注：之后的所有命令都在此目录下执行）</p>

<p>录制音频文件01.wav～50.wave，并置于data/train/speech/目录中（按CTRL-C结束录音）</p>

<pre><code class="language-shell">
rec -b 8 data/train/speech/01.wav

rec -b 8 data/train/speech/02.wav

……

rec -b 8 data/train/speech/50.wav
</code></pre>

<p>录音的内容为：“RED&quot;或&quot;YELLOW&quot;或&quot;BLUE&quot;，总共要50个，以下给了个清单，以供参考（一定要按顺序录制）：</p>

<p>（将此清单保存至&quot;labels&quot;目录下，并且命名为&quot;trainprompts&quot;）</p>

<blockquote>
<p>BLUE<br/><br/>
RED<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
YELLOW<br/><br/>
RED<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
RED<br/><br/>
YELLOW<br/><br/>
YELLOW<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
RED<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
YELLOW<br/><br/>
YELLOW<br/><br/>
BLUE<br/><br/>
RED<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
RED<br/><br/>
BLUE<br/><br/>
YELLOW<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
YELLOW<br/><br/>
RED<br/><br/>
YELLOW<br/><br/>
YELLOW<br/><br/>
YELLOW<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
RED<br/><br/>
RED<br/><br/>
RED<br/><br/>
RED<br/><br/>
BLUE<br/><br/>
YELLOW<br/><br/>
RED<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
BLUE<br/><br/>
YELLOW</p>
</blockquote>

<h2 id="toc_4">二、配置文件准备</h2>

<h3 id="toc_5">1 编写grammer，生成wordnet</h3>

<ul>
<li>手动编辑grammer文件，并置于config目录下，内容如下：</li>
</ul>

<pre><code class="language-shell">$color = RED | BLUE | YELLOW;
(SENT-START ($color) SENT-END)
</code></pre>

<ul>
<li>生成wordnet</li>
</ul>

<pre><code class="language-shell">HParse ./config/grammer ./config/wordnet
</code></pre>

<p>此时，config目录会生成wordnet</p>

<h3 id="toc_6">2 生成字典</h3>

<ul>
<li>手动编辑wordlist文件，并置于lists目录下，wordlist内容如下(内容是经过字典排序的，不要改动)</li>
</ul>

<blockquote>
<p>BLUE<br/><br/>
RED<br/><br/>
SENT-END<br/><br/>
SENT-START<br/><br/>
YELLOW</p>
</blockquote>

<ul>
<li>手动编辑global.ded文件，并置于config目录下，global.ded内容如下<br/></li>
</ul>

<blockquote>
<p>AS sp<br/><br/>
RS cmu  #<br/><br/>
MP sil sil sp</p>
</blockquote>

<ul>
<li>生成monophones和dict_color<br/></li>
</ul>

<p>将字典文件的“beep”和“otherDict&quot;置于dict目录下，然后执行：</p>

<pre><code class="language-shell">HDMan -m -w ./lists/wordlist -n ./lists/monophones -g ./config/global.ded ./dict/dict_color ./dict/beep ./dict/otherDict
</code></pre>

<p>此时，lists目录会生成monophones；dict目录里会生成dict_color；</p>

<h3 id="toc_7">3 ”wav文件清单“转&quot;mlf文件清单</h3>

<ul>
<li>手动编辑labels目录下“trainprompts”文件（还记得“（一）准备训练语音文件”中的那份清单吗？），具体方式为:<br/></li>
</ul>

<blockquote>
<p>BLUE    ===》    s01 SENT-START BLUE SENT-END  </p>
</blockquote>

<p>在原“单词”（此处为&quot;BLUE&quot;）</p>

<p>前缀 &quot;SENT-START&quot;，后缀“SENT-END”，并在行首追加录音文件的文件名&quot;s01&quot;（s01.wav除去扩展名）</p>

<p>修改结果如下如下：</p>

<blockquote>
<p>s01 SENT-START BLUE SENT-END<br/><br/>
s02 SENT-START RED SENT-END<br/><br/>
s03 SENT-START BLUE SENT-END<br/><br/>
s04 SENT-START BLUE SENT-END<br/><br/>
s05 SENT-START BLUE SENT-END<br/><br/>
s06 SENT-START YELLOW SENT-END<br/><br/>
s07 SENT-START RED SENT-END<br/><br/>
s08 SENT-START BLUE SENT-END<br/><br/>
s09 SENT-START BLUE SENT-END<br/><br/>
s10 SENT-START RED SENT-END<br/><br/>
s11 SENT-START YELLOW SENT-END </p>
</blockquote>

<p>生成脚本（半自动）</p>

<pre><code class="language-shell">for i in `cat labels/trainprompts`
do
        echo &#39;SENT-START &#39;$i&#39; SENT-END&#39;
done
</code></pre>

<ul>
<li>”wav文件清单“转&quot;mlf文件清单“： </li>
</ul>

<p>使用脚本文件prompts2mlf</p>

<pre><code class="language-shell">perl ./scripts/prompts2mlf ./labels/trainwords.mlf ./labels/trainprompts
</code></pre>

<p>此时，labels目录会生成trainwords.mlf；</p>

<h3 id="toc_8">4 生成phones_color.led文件：</h3>

<ul>
<li>手动编辑“mkphones_color.led”文件，并置于config目录下，内容如下:<br/></li>
</ul>

<blockquote>
<p>EX<br/><br/>
IS sil sil<br/><br/>
DE sp</p>
</blockquote>

<ul>
<li>生成phones_color.led文件：</li>
</ul>

<pre><code class="language-shell">HLEd -l &#39;*&#39; -d ./dict/dict_color -i ./labels/phones_color.mlf ./config/mkphones_color.led ./labels/trainwords.mlf 
</code></pre>

<p>此时，labels目录会生成phones_color.mlf；</p>

<h3 id="toc_9">5 wav文件转换成mlf文件</h3>

<ul>
<li>手动编辑“转换清单”codetrain.scp，并置于config目录下，内容如下(部分）:</li>
</ul>

<blockquote>
<p>/Users/dingnan/space/htk_color/data/train/speech/s01.wav /Users/dingnan/space/htk_color/data/train/mfc/s01.mfc<br/><br/>
/Users/dingnan/space/htk_color/data/train/speech/s02.wav /Users/dingnan/space/htk_color/data/train/mfc/s02.mfc<br/><br/>
/Users/dingnan/space/htk_color/data/train/speech/s03.wav /Users/dingnan/space/htk_color/data/train/mfc/s03.mfc<br/><br/>
/Users/dingnan/space/htk_color/data/train/speech/s04.wav /Users/dingnan/space/htk_color/data/train/mfc/s04.mfc<br/><br/>
/Users/dingnan/space/htk_color/data/train/speech/s05.wav /Users/dingnan/space/htk_color/data/train/mfc/s05.mfc<br/><br/>
/Users/dingnan/space/htk_color/data/train/speech/s06.wav /Users/dingnan/space/htk_color/data/train/mfc/s06.mfc<br/><br/>
/Users/dingnan/space/htk_color/data/train/speech/s07.wav /Users/dingnan/space/htk_color/data/train/mfc/s07.mfc<br/><br/>
/Users/dingnan/space/htk_color/data/train/speech/s08.wav /Users/dingnan/space/htk_color/data/train/mfc/s08.mfc</p>
</blockquote>

<p>转换脚本（文件多时使用）</p>

<pre><code class="language-shell">for i in `ls data/train/speech`
do
        file_name=`echo $i | awk -F&quot;.&quot; &#39;{print $1}&#39;`
        echo /Users/dingnan/space/htk_color/data/train/speech/$i&quot; &quot;/Users/dingnan/space/htk_color/data/train/mfc/$file_name&quot;.mfc&quot;
done
</code></pre>

<ul>
<li>手动编辑config_HCopy，并置于config目录下，内容如下:</li>
</ul>

<blockquote>
<p># Coding parameters<br/><br/>
TARGETKIND = MFCC_0_D_A<br/><br/>
TARGETRATE = 100000.0<br/><br/>
SAVECOMPRESSED = T<br/><br/>
SAVEWITHCRC = T<br/><br/>
WINDOWSIZE = 250000.0<br/><br/>
USEHAMMING = T<br/><br/>
PREEMCOEF = 0.97<br/><br/>
NUMCHANS = 26<br/><br/>
CEPLIFTER = 22<br/><br/>
NUMCEPS = 12<br/><br/>
ENORMALISE = F<br/><br/>
SOURCEFORMAT = WAV</p>
</blockquote>

<ul>
<li>wav文件转换成mlf文件：</li>
</ul>

<pre><code class="language-shell">HCopy -T 1 -C ./config/config_HCopy -S ./config/codetrain.scp
</code></pre>

<p>此后，data/train/mfc目录会生成s01.mfc；s02.mfc……s49.mfc；s50.mfc；</p>

<h3 id="toc_10">6 生成初始hmm——“hmm0”</h3>

<ul>
<li>手动编辑proto，并置于config目录下，内容如下:</li>
</ul>

<pre><code class="language-shell">~o &lt;VecSize&gt; 39 &lt;MFCC_0_D_A&gt;
~h &quot;proto&quot;
&lt;BeginHMM&gt;
  &lt;NumStates&gt; 5
  &lt;State&gt; 2
    &lt;Mean&gt; 39
      0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
    &lt;Variance&gt; 39
      1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0
 &lt;State&gt; 3
    &lt;Mean&gt; 39
      0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
    &lt;Variance&gt; 39
      1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0
 &lt;State&gt; 4
    &lt;Mean&gt; 39
      0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
    &lt;Variance&gt; 39
      1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0
 &lt;TransP&gt; 5
  0.0 1.0 0.0 0.0 0.0
  0.0 0.6 0.4 0.0 0.0
  0.0 0.0 0.6 0.4 0.0
  0.0 0.0 0.0 0.7 0.3
  0.0 0.0 0.0 0.0 0.0
&lt;EndHMM&gt;
</code></pre>

<ul>
<li>手动编辑train.scp，并置于config目录下，内容如下（其实就是codetrain.scp的“右半边内容”）：</li>
</ul>

<pre><code class="language-shell">/Users/dingnan/space/htk_color/data/train/mfc/s43.mfc
/Users/dingnan/space/htk_color/data/train/mfc/s44.mfc
/Users/dingnan/space/htk_color/data/train/mfc/s45.mfc
/Users/dingnan/space/htk_color/data/train/mfc/s46.mfc
/Users/dingnan/space/htk_color/data/train/mfc/s47.mfc
/Users/dingnan/space/htk_color/data/train/mfc/s48.mfc
/Users/dingnan/space/htk_color/data/train/mfc/s49.mfc
/Users/dingnan/space/htk_color/data/train/mfc/s50.mfc
</code></pre>

<ul>
<li>手动编辑config_color文件，并置于config目录下，内容变为（即”config_HCopy“文件删除“SOURCEFORMAT = WAV”那行）：</li>
</ul>

<pre><code class="language-shell"># Coding parameters
TARGETKIND = MFCC_0_D_A
TARGETRATE = 100000.0
SAVECOMPRESSED = T
SAVEWITHCRC = T
WINDOWSIZE = 250000.0
USEHAMMING = T
PREEMCOEF = 0.97
NUMCHANS = 26
CEPLIFTER = 22
NUMCEPS = 12
ENORMALISE = F
</code></pre>

<ul>
<li>生成初始hmm0的内容：</li>
</ul>

<pre><code class="language-shell">HCompV -C ./config/config_color -f 0.01 -m -S ./config/train.scp -M ./hmm0 ./config/proto
</code></pre>

<p>此时，hmm0目录下会生成proto和vFloors；</p>

<h3 id="toc_11">7 生成macros、hmmdefs和monoOffSP：</h3>

<ul>
<li>生成macros:</li>
</ul>

<pre><code class="language-shell">perl scripts/makeMacros hmm0/vFloors hmm0/macros
</code></pre>

<p>此时，hmm0目录下会生成macros；</p>

<ul>
<li>生成hmmdefs：</li>
</ul>

<pre><code class="language-shell">perl scripts/makeHmmdefs hmm0/proto lists/monophones hmm0/hmmdefs
</code></pre>

<p>此时，hmm0目录下会生成hmmdefs；</p>

<ul>
<li>生成monoOffSP：</li>
</ul>

<pre><code class="language-shell">perl scripts/makeMonoOffsp ./lists/monophones ./lists/monoOffSP
</code></pre>

<p>此时，lists目录下会生成monoOffSP；</p>

<h2 id="toc_12">三、 训练HMM模型</h2>

<p>共迭代7次， 从hmm0到hmm7</p>

<h3 id="toc_13">1 从“hmm0&quot;训练到&quot;hmm3&quot;：</h3>

<pre><code class="language-shell">#以hmm0为基础，生成hmm1
HERest -C ./config/config_color -I ./labels/phones_color.mlf -t 250.0 150.0 1000.0 -S ./config/train.scp -H ./hmm0/macros -H ./hmm0/hmmdefs -M ./hmm1/ ./lists/monoOffSP

#以hmm1为基础，生成hmm2
HERest -C ./config/config_color -I ./labels/phones_color.mlf -t 250.0 150.0 1000.0 -S ./config/train.scp -H ./hmm1/macros -H ./hmm1/hmmdefs -M ./hmm2/ ./lists/monoOffSP

#以hmm2为基础，生成hmm3
HERest -C ./config/config_color -I ./labels/phones_color.mlf -t 250.0 150.0 1000.0 -S ./config/train.scp -H ./hmm2/macros -H ./hmm2/hmmdefs -M ./hmm3/ ./lists/monoOffSP
</code></pre>

<p>以上命令完成之后，在hmm1、hmm2、hmm3目录下都会生成macros和hmmdefs</p>

<h3 id="toc_14">2 “特殊处理”hmm4，并生成hmm5：</h3>

<ul>
<li>获得hmm4目录下hmmdefs文件：</li>
</ul>

<pre><code class="language-shell">perl ./scripts/fixSil hmm3/hmmdefs hmm4/hmmdefs
</code></pre>

<ul>
<li>复制hmm3目录下macros至hmm4目录下：</li>
</ul>

<pre><code class="language-shell">cp hmm3/macros ./hmm4/macros
</code></pre>

<ul>
<li>手动编辑sil.hed文件，并置于config目录下，sil.hed内容如下</li>
</ul>

<pre><code class="language-shell">AT 2 4 0.2 {sil.transP}  
AT 4 2 0.2 {sil.transP}  
AT 1 3 0.3 {sp.transP}  
TI silst  {sil.state[3],sp.state[2]} 
</code></pre>

<ul>
<li>生成hmm5：</li>
</ul>

<pre><code>HHEd -H ./hmm4/macros -H ./hmm4/hmmdefs -M hmm5/ config/sil.hed ./lists/monophones
</code></pre>

<p>此时，hmm5目录下会生成hmmdefs和macros</p>

<ul>
<li>去除mkphones_color.led最后一行，保存文件mkphones_color_HLEd.led至config目录下:</li>
</ul>

<pre><code class="language-shell">HLEd -l &#39;*&#39; -d ./dict/dict_color -i ./labels/phones_color.mlf ./config/mkphones_color_HLEd.led ./labels/trainwords.mlf
</code></pre>

<h3 id="toc_15">3 从“hmm5“训练到&quot;hmm7“：</h3>

<pre><code class="language-shell">#以hmm5为基础，生成hmm6
HERest -C ./config/config_color -I ./labels/phones_color.mlf -t 250.0 150.0 1000.0 -S ./config/train.scp -H ./hmm5/macros -H ./hmm5/hmmdefs -M ./hmm6/ ./lists/monophones

#以hmm6为基础，生成hmm7
HERest -C ./config/config_color -I ./labels/phones_color.mlf -t 250.0 150.0 1000.0 -S ./config/train.scp -H ./hmm6/macros -H ./hmm6/hmmdefs -M ./hmm7/ ./lists/monophones
</code></pre>

<h2 id="toc_16">四、 识别、测试</h2>

<h3 id="toc_17">1 录音</h3>

<ul>
<li><p>录了7个测试音频文件，都放在/Users/dingnan/htk_color/data/test/speech/目录下，分别为</p>

<blockquote>
<p>red.wav：&quot;red&quot;<br/><br/>
blue.wav：&quot;blue&quot;<br/><br/>
red_other.wav：&quot;red&quot;<br/><br/>
blue_other.wav：&quot;blue&quot;<br/><br/>
yellow_other.wav：&quot;yellow&quot;<br/><br/>
null.wav：空录了一段<br/><br/>
pikapika.wav：&quot;pikapika&quot;</p>
</blockquote></li>
</ul>

<h3 id="toc_18">2 wav文件转mfc文件</h3>

<ul>
<li>手动编辑“转换清单”codetest.scp，并置于config目录:</li>
</ul>

<pre><code class="language-shell">/Users/dingnan/space/htk_color/data/test/speech/blue.wav /Users/dingnan/space/htk_color/data/test/mfc/blue.mfc                                                                    
/Users/dingnan/space/htk_color/data/test/speech/blue_other.wav /Users/dingnan/space/htk_color/data/test/mfc/blue_other.mfc                                                        
/Users/dingnan/space/htk_color/data/test/speech/null.wav /Users/dingnan/space/htk_color/data/test/mfc/null.mfc                                                                    
/Users/dingnan/space/htk_color/data/test/speech/pikapika.wav /Users/dingnan/space/htk_color/data/test/mfc/pikapika.mfc                                                            
/Users/dingnan/space/htk_color/data/test/speech/red.wav /Users/dingnan/space/htk_color/data/test/mfc/red.mfc                                                                      
/Users/dingnan/space/htk_color/data/test/speech/red_other.wav /Users/dingnan/space/htk_color/data/test/mfc/red_other.mfc                                                          
/Users/dingnan/space/htk_color/data/test/speech/yellow_other.wav /Users/dingnan/space/htk_color/data/test/mfc/yellow_other.mfc                                                    
</code></pre>

<ul>
<li>wav文件转换成mlf文件:</li>
</ul>

<pre><code class="language-shell">HCopy -T 1 -C ./config/config_HCopy -S ./config/codetest.scp
</code></pre>

<p>此后，data/test/mfc目录会生成red.mfc; blue.mfc; red_other.mfc; blue_other.mfc; yellow_other.mfc; null.mfc; pikapika.mfc;</p>

<h3 id="toc_19">3 识别</h3>

<ul>
<li>手动编辑test.scp，指定了要识别的文件，并置于config目录下，内容如下（其实就是codetest.scp的“右半边内容”）：</li>
</ul>

<pre><code class="language-shell">/Users/dingnan/space/htk_color/data/test/mfc/blue.mfc                                                                                                                             
/Users/dingnan/space/htk_color/data/test/mfc/blue_other.mfc                                                                                                                       
/Users/dingnan/space/htk_color/data/test/mfc/null.mfc                                                                                                                             
/Users/dingnan/space/htk_color/data/test/mfc/pikapika.mfc                                                                                                                         
/Users/dingnan/space/htk_color/data/test/mfc/red.mfc                                                                                                                              
/Users/dingnan/space/htk_color/data/test/mfc/red_other.mfc                                                                                                                        
/Users/dingnan/space/htk_color/data/test/mfc/yellow_other.mfc 
</code></pre>

<ul>
<li>识别，并将识别结果存入result_step7.txt文件：</li>
</ul>

<pre><code class="language-shell">HVite -H ./hmm7/macros -H ./hmm7/hmmdefs -C ./config/config_color -S ./config/test.scp -l &#39;*&#39; -i ./results/result_step7.txt -w ./config/wordnet -p 0.0 -s 5.0 ./dict/dict_color ./lists/monophones
</code></pre>

<ul>
<li>查看结果，结果在result_step7.txt中</li>
</ul>


		</div>

		

	</article>
 
	<article>
		 <header>
		  	<h1 class="entry-title"><a href="14700359952396.html">HDFS数据表Schema</a></h1>
			<p class="meta"><time datetime="2016-08-01T15:19:55+08:00" 
			pubdate data-updated="true">2016/8/1</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<h2 id="toc_0">一、基础数据表</h2>

<h3 id="toc_1">1 用户基础信息表(UserBasicInfo)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>NickName</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>TalkmateID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>性别</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>年龄</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>电话</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>email</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>精通语言</td>
<td>String</td>
<td></td>
<td>数组</td>
</tr>
<tr>
<td>9</td>
<td>国家</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>IP</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>描述</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>12</td>
<td>是否有头像</td>
<td>String</td>
<td>Y/N</td>
<td></td>
</tr>
<tr>
<td>13</td>
<td>爱好</td>
<td>String</td>
<td></td>
<td>数组</td>
</tr>
<tr>
<td>14</td>
<td>已加入班组</td>
<td>String</td>
<td></td>
<td>数组</td>
</tr>
<tr>
<td>15</td>
<td>登录次数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>16</td>
<td>注册时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>17</td>
<td>第三方登录渠道</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>18</td>
<td>最后登录时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>19</td>
<td>active</td>
<td>INT</td>
<td>0/1</td>
<td></td>
</tr>
<tr>
<td>20</td>
<td>信息是否完善</td>
<td>String</td>
<td>Y/N</td>
<td></td>
</tr>
<tr>
<td>21</td>
<td>是否验证邮箱</td>
<td>String</td>
<td>Y/N</td>
<td></td>
</tr>
<tr>
<td>22</td>
<td>正在学的语言</td>
<td>String</td>
<td>语言:模式</td>
<td>数组</td>
</tr>
<tr>
<td>23</td>
<td>剩余金币数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_2">2 课程基础信息表(CourseInfo)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>课程语言ID</td>
<td>String</td>
<td>UZB</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>课程模块ID</td>
<td>String</td>
<td>Basic</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>课程模块名称</td>
<td>String</td>
<td>乌兹别克语教程</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>应用地区</td>
<td>String</td>
<td></td>
<td>数组</td>
</tr>
<tr>
<td>5</td>
<td>描述</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>Lesson数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>所需金币数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>购买次数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>收藏次数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>是否被推荐</td>
<td>String</td>
<td>Y/N</td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>课程状态</td>
<td>String</td>
<td>open、close</td>
<td></td>
</tr>
<tr>
<td>12</td>
<td>课程类型</td>
<td>String</td>
<td></td>
<td>数组</td>
</tr>
</tbody>
</table>

<h3 id="toc_3">3 课程内容基础信息表(CourseInfoDetail)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>课程语言ID</td>
<td>String</td>
<td>ENG</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>课程模块ID</td>
<td>String</td>
<td>Basic</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>LevelID</td>
<td>String</td>
<td>Level1</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>UnitID</td>
<td>String</td>
<td>Unit1</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>LessonID</td>
<td>String</td>
<td>Chapter1</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>PartID</td>
<td>String</td>
<td>A8是作业</td>
<td>Slide_type</td>
</tr>
<tr>
<td>7</td>
<td>SlideID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>FormID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>Slide内容类型</td>
<td>String</td>
<td>speakToImg</td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>Slide难度</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>内容</td>
<td>String</td>
<td>She is a girl.</td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_4">4 课程学习进度表(UserCourseProgress)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>课程语言ID</td>
<td>String</td>
<td>ENG</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>课程模块ID</td>
<td>String</td>
<td>Basic</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>LessonID</td>
<td>String</td>
<td></td>
<td>chapter</td>
</tr>
<tr>
<td>7</td>
<td>已解锁内容</td>
<td>String</td>
<td>json</td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_5">5 课程学习记录表(UserCourseRecord)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>课程语言ID</td>
<td>String</td>
<td>ENG</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>课程模块ID</td>
<td>String</td>
<td>Basic</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>LessonID</td>
<td>String</td>
<td></td>
<td>chapter</td>
</tr>
<tr>
<td>7</td>
<td>已学习Forms</td>
<td>String</td>
<td>json</td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_6">6 班组基础信息表(GroupInfo)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>CreatorID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Group名称</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>课程语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>课程模块ID</td>
<td>String</td>
<td></td>
<td>ENG-Basic</td>
</tr>
<tr>
<td>6</td>
<td>个人介绍</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>标签ID</td>
<td>String</td>
<td></td>
<td>数组</td>
</tr>
<tr>
<td>8</td>
<td>教材内容</td>
<td>String</td>
<td></td>
<td>数组</td>
</tr>
<tr>
<td>9</td>
<td>开始时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>结束时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>创建时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>12</td>
<td>人数限制</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>13</td>
<td>成员</td>
<td>String</td>
<td></td>
<td>数组</td>
</tr>
<tr>
<td>14</td>
<td>班组说明</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>15</td>
<td>是否删除</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>16</td>
<td>是否推荐</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>17</td>
<td>教育目标</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_7">7 班组成员信息表(GroupMembers)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>role</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>is_del</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_8">8 用户推送作业表(UserPushHomework)-周</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>HomeworkID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>推送依据</td>
<td>INT</td>
<td>课程、精通语言</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>是否批改</td>
<td>String</td>
<td>Y/N</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>创建时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h2 id="toc_9">二、注册登录日志表(001)</h2>

<h3 id="toc_10">1 用户注册日志(UserRegister)(0001)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>注册方式</td>
<td>String</td>
<td>email/phonenumber</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>注册方式内容</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>昵称</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>擅长语言</td>
<td>String</td>
<td></td>
<td>数组</td>
</tr>
<tr>
<td>6</td>
<td>想学习的语言</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>设备类型</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>是否第三方</td>
<td>String</td>
<td>Y/N</td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>第三方来源</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>IP</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>注册时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_11">2 用户登录日志(UserLogin)(0010)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>登录方式</td>
<td>String</td>
<td>email/phonenumber</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>登录方式内容</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>设备类型</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>是否第三方</td>
<td>String</td>
<td>Y/N</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>第三方来源</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>IP</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>登录时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_12">3 用户绑定/解绑日志(UserBindActivity)(0011)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>行为</td>
<td>String</td>
<td>bind/unbind</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>方式</td>
<td>String</td>
<td>手机/邮箱</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>内容</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_13">2 用户打开APP(UserOpenApp)(0100)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>设备类型</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>IP</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>登录时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h2 id="toc_14">三、课程业务日志表(010)</h2>

<h3 id="toc_15">1 用户购买课程日志(UserCourseBuy)(0001)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>课程语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>课程模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>消耗金币数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>是否购买成功</td>
<td>String</td>
<td>Y/N</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_16">2 用户搜索课程日志(UserCourseSearch)(0010)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>搜索内容</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_17">3 用户删除课程日志(UserCourseDelete)(0011)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>课程语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>课程模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>删除时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_18">4 用户切换模式日志(UserCourseModeSwitch)(0100)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>课程语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>课程模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>切换到模式</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>操作时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_19">5 用户学前测试结果日志(UserPreLearnTestResult)(0101)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>语言表达得分</td>
<td>String</td>
<td></td>
<td>expression</td>
</tr>
<tr>
<td>5</td>
<td>综合应用得分</td>
<td>String</td>
<td></td>
<td>apply</td>
</tr>
<tr>
<td>6</td>
<td>母语思维得分</td>
<td>String</td>
<td></td>
<td>thinking</td>
</tr>
<tr>
<td>7</td>
<td>句子理解得分</td>
<td>String</td>
<td></td>
<td>sentence</td>
</tr>
<tr>
<td>8</td>
<td>语言逻辑得分</td>
<td>String</td>
<td></td>
<td>logic</td>
</tr>
<tr>
<td>9</td>
<td>语言解锁级别</td>
<td>String</td>
<td>level</td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>测试时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_20">6 用户学前测试详情日志(UserPreLearnTestResultDetail)(TODO)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>测试ID</td>
<td>BIGINT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>SlideID</td>
<td>BIGINT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>是否答对</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>测试时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_21">7 用户单元测试结果日志(UserUnitTestResult)(0111)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>语言表达得分</td>
<td>INT</td>
<td></td>
<td>expression</td>
</tr>
<tr>
<td>7</td>
<td>综合应用得分</td>
<td>INT</td>
<td></td>
<td>apply</td>
</tr>
<tr>
<td>8</td>
<td>母语思维得分</td>
<td>INT</td>
<td></td>
<td>thinking</td>
</tr>
<tr>
<td>9</td>
<td>句子理解得分</td>
<td>INT</td>
<td></td>
<td>sentence</td>
</tr>
<tr>
<td>10</td>
<td>语言逻辑得分</td>
<td>INT</td>
<td></td>
<td>logic</td>
</tr>
<tr>
<td>11</td>
<td>语言表达总分</td>
<td>INT</td>
<td></td>
<td>expression_total</td>
</tr>
<tr>
<td>12</td>
<td>综合应用总分</td>
<td>INT</td>
<td></td>
<td>apply_total</td>
</tr>
<tr>
<td>13</td>
<td>母语思维总分</td>
<td>INT</td>
<td></td>
<td>thinking_total</td>
</tr>
<tr>
<td>14</td>
<td>句子理解总分</td>
<td>INT</td>
<td></td>
<td>sentence_total</td>
</tr>
<tr>
<td>15</td>
<td>语言逻辑总分</td>
<td>INT</td>
<td></td>
<td>logic_total</td>
</tr>
<tr>
<td>16</td>
<td>测试总分</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>17</td>
<td>测试时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_22">8 用户单元测试详情日志(UserUnitTestResultDetail)(TODO)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>测试ID</td>
<td>BIGINT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>FormID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>SlideID</td>
<td>INT</td>
<td>体现内容间的先后顺序</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>是否答对</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>测试时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_23">9 用户学习结果日志(UserLearnResult)(TODO)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>PartID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>LessonID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>用户当前学习模式</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>获得金币数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>获得经验数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>完成时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_24">10 用户学习详情日志(UserLearnResultDetail)(1010)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>LessonID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>PartID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>SlideID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>FormID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>是否答对</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>完成时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_25">11 用户每日金币日志(UserCoinChange)(1011)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>增加或减少</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>变化数量</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>变化事件</td>
<td>String</td>
<td>学习、游戏、完善个人资料、购买课程、充值</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>事件描述</td>
<td>String</td>
<td>CourseID</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_26">12 用户作业提交日志(UserHomeworkSubmit)(1100)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>HomeworkID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>LessonID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>PartID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>SlideID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>FormID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>内容</td>
<td>String</td>
<td>sentence、url</td>
<td></td>
</tr>
<tr>
<td>12</td>
<td>类型</td>
<td>String</td>
<td>character、sound</td>
<td></td>
</tr>
<tr>
<td>13</td>
<td>提交时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_27">13 用户作业批改日志(UserHomeworkModify)(1101)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>批改者ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>HomeworkID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>批改行为</td>
<td>String</td>
<td>点赞、语音、文字</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>批改时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h2 id="toc_28">四、班组业务日志表(011)</h2>

<h3 id="toc_29">1 创建班组日志(GroupCreate)(0001)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>老师ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>创建时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_30">2 加入班组日志(UserJoinGroup)(0010)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>学生ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>申请时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_31">3 退出班组日志(UserExitGroup)(0011)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>学生ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>退出时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_32">4 加入班组审核日志(GroupAudit)(0100)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>老师ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>学生ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>审核结果</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>审核时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_33">5 班组搜索日志(UserGroupSearch)(0101)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>搜索内容</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>操作时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_34">6 班组解散日志(GroupDestroy)(0110)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>老师ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>操作时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_35">7 督促学习日志(GroupRemindLearn)(0111)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>老师ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>学生ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>督促时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_36">8 班组删除学生日志(GroupRemoveStudent)(1000)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>老师ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>学生ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>删除时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_37">9 班组学习结果日志(UserGroupLearnResult)(TODO)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>学生ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>PartID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>LessonID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>获得金币数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>获得经验数</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>完成时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_38">10 班组学习详情日志(UserGroupLearnResultDetail)(1010)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>学生ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>LessonID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>PartID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>SlideID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>FormID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>是否答对</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>完成时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_39">11 创建晨读日志(GroupMorningReadingCreate)(1011)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>老师ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>晨读ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>内容</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>开始时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>创建时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_40">12 学生晨读日志(UserMorningReadingActivity)(1100)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>晨读ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>跟读ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>跟读类型</td>
<td>String</td>
<td>comment sound</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>跟读内容</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>晨读时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_41">13 晨读评论日志(GroupMorningReadingComment)(1101)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>晨读ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>被评论人ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>跟读ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>评论类型</td>
<td>String</td>
<td>comment praise sound</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>评论内容</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>批改时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_42">14 班组作业提交日志(UserGroupHomeworkSubmit)(1110)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>HomeworkID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>8</td>
<td>LessonID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>PartID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>10</td>
<td>SlideID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>11</td>
<td>FormID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>12</td>
<td>内容</td>
<td>String</td>
<td>sentence、url</td>
<td></td>
</tr>
<tr>
<td>13</td>
<td>类型</td>
<td>String</td>
<td>character、sound</td>
<td></td>
</tr>
<tr>
<td>14</td>
<td>提交时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_43">15 班组单元测试结果日志(UserGroupUnitTestResult)(1111)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>Course语言ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>Course模块ID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>LevelID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>UnitID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>7</td>
<td>语言表达得分</td>
<td>INT</td>
<td></td>
<td>expression</td>
</tr>
<tr>
<td>8</td>
<td>综合应用得分</td>
<td>INT</td>
<td></td>
<td>apply</td>
</tr>
<tr>
<td>9</td>
<td>母语思维得分</td>
<td>INT</td>
<td></td>
<td>thinking</td>
</tr>
<tr>
<td>10</td>
<td>句子理解得分</td>
<td>INT</td>
<td></td>
<td>sentence</td>
</tr>
<tr>
<td>11</td>
<td>语言逻辑得分</td>
<td>INT</td>
<td></td>
<td>logic</td>
</tr>
<tr>
<td>12</td>
<td>语言表达总分</td>
<td>INT</td>
<td></td>
<td>expression_total</td>
</tr>
<tr>
<td>13</td>
<td>综合应用总分</td>
<td>INT</td>
<td></td>
<td>apply_total</td>
</tr>
<tr>
<td>14</td>
<td>母语思维总分</td>
<td>INT</td>
<td></td>
<td>thinking_total</td>
</tr>
<tr>
<td>15</td>
<td>句子理解总分</td>
<td>INT</td>
<td></td>
<td>sentence_total</td>
</tr>
<tr>
<td>16</td>
<td>语言逻辑总分</td>
<td>INT</td>
<td></td>
<td>logic_total</td>
</tr>
<tr>
<td>17</td>
<td>测试总分</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>18</td>
<td>测试时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h2 id="toc_44">四、操作记录表(TODO)</h2>

<h3 id="toc_45">1 课程搜索结果点击日志(CourseSearchClickRecord)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>CourseID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>点击时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_46">2 学习页设置功能点击日志(ConfigButtonClickRecord）</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>UserID</td>
<td>INT</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>设置项</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>点击时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

<h3 id="toc_47">3 班组搜索点击日志(GroupSearchClickRecord)</h3>

<p><strong>Schema</strong></p>

<table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>类型</th>
<th>描述</th>
<th>备注</th>
</tr>
</thead>

<tbody>
<tr>
<td>1</td>
<td>GroupID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>UserID</td>
<td>String</td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>点击时间</td>
<td>String</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>


		</div>

		

	</article>
 
	<article>
		 <header>
		  	<h1 class="entry-title"><a href="14700356814047.html">基于HTK的孤立词有监督识别</a></h1>
			<p class="meta"><time datetime="2016-08-01T15:14:41+08:00" 
			pubdate data-updated="true">2016/8/1</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<blockquote>
<p>训练多个模型，一个单词对应一个模型</p>
</blockquote>

<p>实现的是6个单词的识别，即：hello, world, port, starboard, standby, steer<br/><br/>
新建八个文件夹: def, hmms, models, lab, sig, mfcc, results, test，<br/>
<img src="http://10.0.1.215/markdown/htk_supervised_2" alt=""/></p>

<h2 id="toc_0">一、数据录制与标注，涉及文件夹：sig， lab</h2>

<p>在命令提示符中进入当前目录，就是上面八个文件夹所在的目录，然后进入sig目录，我们先把录制的.sig格式语音和.lab格式的标注文件放这里。先录制第一个单词，即“hello”.在命令提示符中输入：HSLab hello.sig出现录音与标注界面，按下rec录音，按下stop停止录音，然后按下mark进行标记，并对每一段标记命名（Mark后点Labelas）。前后为静音，中间为识别单词，注意，每段标记需要有一定的间隔，不能重合，否则在使用Hinit的时候会出错。标记完后点击保存，注意命名，默认是hello_0.lab和hello_1.lab,需要手动更改。如图：</p>

<p><img src="http://10.0.1.215/markdown/htk_supervised_1" alt=""/></p>

<p>重复录制10遍hello并标注，并用同样方法录制与标注剩余的单词各10遍。然后把sig文件夹里的.lab文件剪切到lab文件夹。hello_1.lab中的数据为：</p>

<p><img src="http://10.0.1.215/markdown/htk_supervised_label" alt=""/></p>

<h2 id="toc_1">二、 原始语音文件转换为特征矢量文件，涉及文件夹： sig，lab，mfcc，test</h2>

<h3 id="toc_2">1. 在test文件夹中新建analysis.conf文件，内容为：</h3>

<pre><code class="language-shell">SOURCEFORMAT=HTK  
TARGETKIND=MFCC_0_D_A  
WINDOWSIZE=250000.0  
TARGETRATE=100000.0  
NUMCEPS=12  
USEHAMMING=T  
PREEMCOEF=0.97  
NUMCHANS=26  
CEPLIFTER=22  
</code></pre>

<h3 id="toc_3">2. 在def文件夹中新建targetlist.txt，内容为（由于有6个单词，每个单词有10条，共60条，故这里列出了前10条，即hello的转换，以这个格式复制5遍，把hello替换成其他单词即可）:</h3>

<pre><code class="language-shell">sig/hello_1.sig mfcc/hello_1.mfcc  
sig/hello_2.sig mfcc/hello_2.mfcc  
sig/hello_3.sig mfcc/hello_3.mfcc  
sig/hello_4.sig mfcc/hello_4.mfcc  
sig/hello_5.sig mfcc/hello_5.mfcc  
sig/hello_6.sig mfcc/hello_6.mfcc  
sig/hello_7.sig mfcc/hello_7.mfcc  
sig/hello_8.sig mfcc/hello_8.mfcc  
sig/hello_9.sig mfcc/hello_9.mfcc  
sig/hello_10.sig mfcc/hello_10.mfcc
</code></pre>

<p>然后输入命令：</p>

<pre><code class="language-shell">Hcopy -A -D -C test/analysis.conf -S def/targetlist.txt
</code></pre>

<p>出现的界面为：<br/>
<img src="http://10.0.1.215/markdown/htk_supervised_copy" alt=""/></p>

<p>然后在mfcc文件夹中出现.mfcc文件，如图：</p>

<p><img src="http://10.0.1.215/markdown/htk_supervised_mfcc" alt=""/></p>

<h2 id="toc_4">三、 建立HMM模型，涉及文件夹：models，test，hmms，lab</h2>

<h3 id="toc_5">1. 在models文件夹中新建7个文件，即：hmm_hello, hmm_world, hmm_port, hmm_starboard, hmm_standby, hmm_steer, hmm_sil</h3>

<p>在hmm_hello文件中输入如下内容：</p>

<pre><code class="language-shell">~o &lt;VecSize&gt; 39 &lt;MFCC_0_D_A&gt; 
~h &quot;hello&quot; 
&lt;BeginHMM&gt; 
&lt;NumStates&gt; 10 
&lt;State&gt; 2  
&lt;Mean&gt; 39 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;Variance&gt; 39 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
&lt;State&gt; 3  
&lt;Mean&gt; 39 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;Variance&gt; 39 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
&lt;State&gt; 4  
&lt;Mean&gt; 39 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;Variance&gt; 39 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
&lt;State&gt; 5 
&lt;Mean&gt; 39 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;Variance&gt; 39 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
&lt;State&gt; 6  
&lt;Mean&gt; 39 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;Variance&gt; 39 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
&lt;State&gt; 7  
&lt;Mean&gt; 39 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;Variance&gt; 39 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
&lt;State&gt; 8  
&lt;Mean&gt; 39 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;Variance&gt; 39 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
&lt;State&gt; 9  
&lt;Mean&gt; 39 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;Variance&gt; 39 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
&lt;TransP&gt; 10 
0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.5 0.5 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.5 0.5 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.5 0.5 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.5 0.5 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.5 0.5 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.5 0.5 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.5 0.5 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.5 0.5 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;EndHMM&gt;
</code></pre>

<p>其他5个单词只需把~h”hello”中的hello替换即可。<br/>
sil即静音模型，在hmm_sil中输入如下内容：</p>

<pre><code class="language-shell">~o &lt;VecSize&gt; 39 &lt;MFCC_0_D_A&gt; 
~h &quot;sil&quot; 
&lt;BeginHMM&gt; 
&lt;NumStates&gt; 3 
&lt;State&gt; 2  
&lt;Mean&gt; 39 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 
&lt;Variance&gt; 39 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 
&lt;TransP&gt; 3 
0.0 1.0 0.0 
0.0 0.5 0.5 
0.0 0.0 0.0 
&lt;EndHMM&gt;
</code></pre>

<h3 id="toc_6">2. hmm初始化</h3>

<p>在test文件夹中新建trainlist.txt文件，内容为（这里只列出了hello的10条，其他5个单词复制5遍替换hello即可）：</p>

<pre><code class="language-shell">mfcc/hello_1.mfcc
mfcc/hello_2.mfcc
mfcc/hello_3.mfcc
mfcc/hello_4.mfcc
mfcc/hello_5.mfcc
mfcc/hello_6.mfcc
mfcc/hello_7.mfcc
mfcc/hello_8.mfcc
mfcc/hello_9.mfcc
mfcc/hello_10.mfcc
</code></pre>

<p>在hmms文件夹中新建hmm0文件夹，然后执行命令：</p>

<pre><code class="language-shell">Hinit -A -D -T 1 -S test/trainlist.txt -M hmms/hmm0 –H models/hmm_hello –l hello –L lab hello
Hinit -A -D -T 1 -S test/trainlist.txt -M hmms/hmm0 –H models/hmm_world –l world –L lab world
Hinit -A -D -T 1 -S test/trainlist.txt -M hmms/hmm0 –H models/hmm_port –l port –L lab port
Hinit -A -D -T 1 -S test/trainlist.txt -M hmms/hmm0 –H models/hmm_starboard –l starboard –L lab starboard
Hinit -A -D -T 1 -S test/trainlist.txt -M hmms/hmm0 –H models/hmm_standby –l standby –L lab standby
Hinit -A -D -T 1 -S test/trainlist.txt -M hmms/hmm0 –H models/hmm_steer –l steer –L lab steer
Hinit -A -D -T 1 -S test/trainlist.txt -M hmms/hmm0 –H models/hmm_sil –l sil–L lab sil
</code></pre>

<p>初始化hello完成界面如图:</p>

<p>所有单词初始化完成后我们可以在hmm0文件夹中得到对应的模型文件。这一步很容易出错，如果出错请检查数据标注的时候是否有重合。</p>

<h3 id="toc_7">3. 如果初始化成功，则可以进行hmm训练</h3>

<p>在hmms中新建三个文件夹,hmm1,hmm2,hmm3<br/>
使用命令:</p>

<pre><code class="language-shell">HRest -A -D -T 1 -S test/trainlist.txt -M hmms/hmm1 -H hmms/hmm0/hmm_hello  -l hello  -L lab hello  
HRest -A -D -T 1 -S test/trainlist.txt -M hmms/hmm2 -H hmms/hmm1/hmm_hello  -l hello  -L lab hello  
HRest -A -D -T 1 -S test/trainlist.txt -M hmms/hmm3 -H hmms/hmm2/hmm_hello  -l hello  -L lab hello 
</code></pre>

<p>这里只列出hello的训练，其他单词与sil的训练只需把hello替换成相应单词和sil即可。<br/>
最后我们可以在hmm3文件中得到模型文件。</p>

<h2 id="toc_8">四、 建立语法规则与字典，涉及文件夹：def</h2>

<h3 id="toc_9">1. 在def文件夹中新建gram.txt文件，输入语法：</h3>

<pre><code class="language-shell">$WORD=HELLO | WORLD | PORT | STARBOARD | STANDBY | STEER;  
({START_SIL}[$WORD]{END_SIL})  
</code></pre>

<h3 id="toc_10">2. 在def文件夹中新建dict.txt文件，输入字典：</h3>

<pre><code class="language-shell">HELLO [hello] hello  
WORLD [world] world  
PORT [port] port  
STARBOARD [starboard] starboard  
STANDBY [standby] standby  
STEER [steer] steer  
START_SIL [sil] sil  
END_SIL [sil] sil  
</code></pre>

<h3 id="toc_11">3. 建立任务网络</h3>

<p>输入命令：</p>

<pre><code class="language-shell">Hparse -A -D -T 1 def/gram.txt def/net.slf
</code></pre>

<p>在def文件中生成了net.slf文件，其内容形式如下：</p>

<p><img src="http://10.0.1.215/markdown/htk_supervised_net" alt=""/></p>

<h2 id="toc_12">五、识别,涉及文件夹：def, hmms, models, test，results</h2>

<h3 id="toc_13">1. 在results文件夹中新建reco.mlf文件</h3>

<h3 id="toc_14">2. 在test文件夹中新建hmmsdef.mmf文件，其内容为hmms/hmm3文件夹中的所有hmm_xxx的数据，注意：在第一个复制进去的hmm_xxx为全部数据，剩下的从第一行的~h开始复制，也就是说只保留第一个~o。</h3>

<h3 id="toc_15">3. 此时可以用一个.mfcc文件进行测试，先在test文件中新建一个hmmlist.txt文件，内容为：</h3>

<pre><code class="language-shell">hello  
world  
port  
starboard  
standby  
steer  
sil  
</code></pre>

<p>命令为：</p>

<pre><code class="language-shell">Hvite -A -D -T 1 -H test/hmmsdef.mmf -i result/reco.mlf -w def/net.slf def/dict.txt test/hmmlist.txt mfcc /hello_1.mfcc
</code></pre>

<h3 id="toc_16">4. 交互识别</h3>

<p>在test文件夹中新建directin.conf文件，内容为：</p>

<pre><code class="language-shell">SOURCERATE=625.0    
SOURCEKIND=HAUDIO  
SOURCEFORMAT=HTK    
TARGETKIND=MFCC_0_D_A  
WINDOWSIZE=250000.0  
TARGETRATE=100000.0  
NUMCEPS=12  
USEHAMMING=T  
PREEMCOEF=0.97  
NUMCHANS=26  
CEPLIFTER=22  
AUDIOSIG=-1  
</code></pre>

<p>输入命令：</p>

<pre><code class="language-shell">HVite -A -D -T 1 -C test/directin.conf -g -H test/hmmsdef.mmf -w def/net.slf def/dict.txt test/hmmlist.txt
</code></pre>

<p><img src="http://10.0.1.215/markdown/htk_supervised_interact" alt=""/><br/>
可以动态识别说话的结果，未测试。</p>

<h2 id="toc_17">六、 性能评价，涉及文件夹：test，results</h2>

<h3 id="toc_18">1. 在test文件夹中新建文件ref.mlf，输入内容形如下列（这里只列举hello，每个单词选3个.lab文件即可）：</h3>

<pre><code class="language-shell">#!MLF!#  
&quot;lab/hello_1.lab&quot;  
20625 5693750   
sil  
5778750 10477500 hello  
10562500 14500000 sil  
  
&quot;lab/hello_2.lab&quot;  
20625 4995000 sil  
5058750 12975625 hello  
13039375 14500000 sil  
  
&quot;lab/hello_3.lab&quot;  
20625 5333750 sil  
5397500 10520000 hello  
10541250 14500000 sil  
</code></pre>

<h3 id="toc_19">2. 在test文件夹中新建testlist.txt文件，用以创建测试路径，内容形如下列：</h3>

<pre><code class="language-shell">test/mfcc/hello_1.mfcc  
test/mfcc/hello_2.mfcc  
test/mfcc/hello_3.mfcc  
test/mfcc/world_1.mfcc  
test/mfcc/world_2.mfcc  
test/mfcc/world_3.mfcc  
test/mfcc/port_1.mfcc  
test/mfcc/port_2.mfcc  
test/mfcc/port_3.mfcc  
test/mfcc/starboard_1.mfcc  
test/mfcc/starboard_2.mfcc  
test/mfcc/starboard_3.mfcc  
test/mfcc/standby_1.mfcc  
test/mfcc/standby_2.mfcc  
test/mfcc/standby_3.mfcc  
test/mfcc/steer_1.mfcc  
test/mfcc/steer_2.mfcc  
test/mfcc/steer_3.mfcc 
</code></pre>

<h3 id="toc_20">3. 使用命令：</h3>

<pre><code class="language-shell">HVite -A -D -T 1 -S test/testlist.txt -H test/hmmsdef.mmf -i results/reco.mlf -w def/net.slf def/dict.txt test/hmmlist.txt 
</code></pre>

<p>完成界面为：<br/>
<img src="http://10.0.1.215/markdown/htk_supervised_result" alt=""/><br/>
results文件中的reco.mlf就保存了结果</p>

<h3 id="toc_21">4. 错误率统计</h3>

<p>在test文件夹中新建labellist.txt文件，内容为：</p>

<pre><code class="language-shell">lab/hello_1.lab  
lab/hello_2.lab  
lab/hello_3.lab  
lab/world_1.lab  
lab/world_2.lab  
lab/world_3.lab  
lab/port_1.lab  
lab/port_2.lab  
lab/port_3.lab  
lab/starboard_1.lab  
lab/starboard_2.lab  
lab/starboard_3.lab  
lab/standby_1.lab  
lab/standby_2.lab  
lab/standby_3.lab  
lab/steer_1.lab  
lab/steer_2.lab  
lab/steer_3.lab 
</code></pre>

<p>然后使用命令：</p>

<pre><code class="language-shell">HResults -I test/ref.mlf  test/labellist.txt results/reco.mlf 
</code></pre>

<p>得到错误率统计界面：<br/>
<img src="http://10.0.1.215/markdown/htk_supervised_statistic" alt=""/><br/>
SENT: %Correct=94.44 为句子识别率，WORD:%Corr=98.11为单词识别率。</p>

<h2 id="toc_22">七、 文件</h2>

<pre><code class="language-shell">wget http://10.0.1.215/htk/htk_singleword.tar.gz
</code></pre>


		</div>

		

	</article>
 
	<article>
		 <header>
		  	<h1 class="entry-title"><a href="14700283558768.html">Kaldi 笔记</a></h1>
			<p class="meta"><time datetime="2016-08-01T13:12:35+08:00" 
			pubdate data-updated="true">2016/8/1</time></p>
		 </header>
	  	<div class="entry-content">
		  	
		  	<h2 id="toc_0">一、基本数据结构</h2>

<ol>
<li>数据准备

<ol>
<li>需要手动创建的文件

<ol>
<li><strong>data/train_yesno/text</strong><br/>

<ol>
<li>每行两项，第一项是发音编号（utterance-id），第二项是文本内容，不需要保证每个词都在词典中，因为词典之外的词会映射到data/lang/oov.txt</li>
</ol></li>
<li><strong>data/train_yesno/wav.scp</strong>

<ol>
<li>格式：<recording-id> &lt;文件路径+名称&gt;，其实就是标记输入</li>
</ol></li>
<li><strong>data/train_yesno/utt2spk</strong>

<ol>
<li>格式：<utterance-id> <speaker-id> 每个话对应的人的id，也就是说可以训练针对某人的语音模型</li>
<li>其他</li>
<li>注意：Kaldi 的I/O框架采用fseek()读取，因此所有字典、映射文件需要排序，否则会发生错误，因此确保locale设置为export LC_ALL=C，保持统一</li>
</ol></li>
</ol></li>
<li>不需要手动创建的文件<br/>

<ol>
<li><strong>data/train_yesno/spk2utt</strong>

<ol>
<li>格式：<speaker-id> <utterance-id1> <utterance-id2> ，通过local/prepare_data.sh:<strong>utils/utt2spk_to_spk2utt.pl</strong>创建，实际是uut2spk的倒排</li>
</ol></li>
<li><strong>data/train_yesno/feats.scp</strong>

<ol>
<li>格式：<utterance-id> <extended-filename-of-features> 每一个特征文件保存的都是Kaldi格式的矩阵。在这个例子中,矩阵的维度是13，即列数; 行数则和文件长度有关,标准情况下帧长 20ms,帧移 10ms,所以一行特征数对应10ms的音频数据。</li>
<li>**/home/talkmate/space/KALDI/kaldi/egs/yesno/s5/mfcc/raw_mfcc_train_yesno.1.ark:16 <strong>的意思是打开archive文件/home/talkmate/space/KALDI/kaldi/egs/yesno/s5/mfcc/raw_mfcc_train_yesno.1.ark并 fseek()到第16字节开始读取</strong>。**</li>
</ol></li>
<li><strong>data/train_yesno/cmvn.scp</strong>

<ol>
<li>包含倒谱均值和方差统计量</li>
</ol></li>
<li>其他</li>
</ol></li>
<li>lang目录的建立，<strong>utils/prepare_lang.sh</strong>, 几个关键文件：

<ol>
<li>oov.txt:不包含在词典中的词</li>
<li>lexicon.txt：词典文件</li>
<li>topo：HMM模型的拓扑结构</li>
<li>silence.txt：静音词</li>
<li>nonsilence.txt：非静音词</li>
<li>phones.txt：音素</li>
<li>words.txt：词</li>
<li>L.fst： fst格式的词典映射</li>
</ol></li>
</ol></li>
<li>特征提取

<ol>
<li>steps/make_mfcc.sh</li>
<li>steps/compute_cmvn_stats.sh</li>
</ol></li>
<li>准备lang

<ol>
<li>utils/prepare_lang.sh</li>
<li>utils/format_lm.sh language model  生成G.fst</li>
</ol></li>
<li><p>建模</p>

<ol>
<li><p>train_mono.sh</p>

<ol>
<li>依据之前计算的cmvn，处理特征feature， ark,s,cs ： ark格式，sort，并保证按排序的顺序调用

<ol>
<li>--utt2spk: 默认是按每条utterance处理，如果增加了utt2spk选项，则按照每个speaker处理</li>
<li>add-deltas : 训练数据增加差分量，比如13维度mfcc处理后变成39维</li>
</ol></li>
<li>gmm-init-mono：初始化，通过之前的特征处理、抽取特征子集、topo、特征维度等输入，训练出0.mdl和tree<br/>

<ol>
<li>draw-tree data/lang/phones.txt exp/mono/tree | dot -Tps -Gsize=8,10.5 | ps2pdf - ~/tree.pdf可以看到数的结构</li>
<li><img src="http://10.0.1.215/markdown/kaldi_tree" alt=""/><br/></li>
</ol></li>
<li><p>compile-train-graphs：生成训练图， 最小单位是状态，我理解就是帧，帧的状态转移构成音素，就是一个基本的HMM，然后复制成三份、更新、配和混合高斯分布，生成一个三音素的HMM</p>

<ol>
<li>通过初试模型0.mdl、tree、L.fst生成解码图fst.JOB.gz，其中text又words.txt转换为INT索引方式</li>
<li>这样，每句话转换成一个FST结构，输入是音素，输出是句子</li>
<li>fstcopy &#39;ark:gunzip -c exp/mono0a/graphs.fsts.gz|&#39; ark,t:-<br/>
fcompile 1 1.fst<br/>
fstdraw 1.fst 1.dot<br/>
dot -Tps -Gsize=8,10.5 1.dot | ps2pdf - 1.pdf
4.<img src="http://10.0.1.215/markdown/kaldi_fst.png" alt=""/></li>
</ol></li>
<li><p>align-equal-compiled</p>

<ol>
<li> Write an equally spaced alignment (for getting training started)Usage:  align-equal-compiled <graphs-rspecifier> <features-rspecifier> <alignments-wspecifier>  <strong>e.g.</strong> : align-equal-compiled 1.fsts scp:train.scp ark:equal.ali</li>
<li>对解码图做等距解码对齐，这个只在更新模型前做一次</li>
</ol></li>
<li><p><strong>gmm-acc-stats-ali：对齐</strong>  </p>

<ol>
<li>Accumulate stats for GMM training.   <strong>Viterbi 1-best path，相当于E。</strong></li>
<li>计算模型的acc，也就是根据对齐的信息，计算每个高斯分布的均值和方差</li>
</ol></li>
<li><p><strong>gmm-est： update</strong>  </p>

<ol>
<li> Estimate SGMM model parameters from accumulated stats. 相当于M<br/></li>
<li> 这里的--min-gaussian-occupancy=3参数很重要，因为这里只是指定了混合高斯总数的上限，不指定单个音素的高斯下限会丢失稀疏音素，无法保证正确对齐<br/></li>
<li>--mix-up指定高斯总数，前面通过gmm-info计算出来的</li>
</ol></li>
<li><p>gmm-sum-accs 计算累计误差，把多个JOB的累加</p>

<ol>
<li>生成1.mdl</li>
</ol></li>
<li><p>进入模型迭代x:</p>

<ol>
<li>gmm-align-compiled 通过模型来对齐特征，不是每次都做

<ul>
<li>关键参数 --beam 和 --retry-beam，在Viterbi剪枝时用，如果用—beam没有到结束状态，再用--retry-beam试一次，不行就放弃</li>
</ul></li>
<li>gmm-boost-silence 修改GMM的权重，来调整指定silence音素模型的概率，如果silence和其他模型共享GMM权重，共享的所有模型都会修改</li>
<li>gmm-acc-stats-ali</li>
<li>gmm-est</li>
</ol></li>
</ol></li>
<li><p>train_deltas.sh   训练三音素模型</p>

<ol>
<li>脚本的后面与单因素模型类似，前面增加了合并、建树的过程

<ol>
<li>N: context-width，P: central-position<br/>
N代表上下文相关音素窗的宽度,P表示指定中心音素。正常的P是窗的中心(因此名字叫中心位置);举个例子,当 N=3,中心位置就是 P=1,但是你可以 自由的选择0到 N-1中的任何值;比如,P=2和 N=3表示有2个音素在左边的上下 文,而右边没有上下文。</li>
<li>build-tree 建树，需要三个东西：

<ol>
<li>统计量: 通过程序 acc-tree-stats 得到 然后 sum-tree-stats</li>
<li>questions：通过cluster-phones 得到</li>
<li>根文件：utils/prepare_lang.sh文件里有生成</li>
</ol></li>
</ol></li>
<li>相关脚本（按顺序）

<ol>
<li><strong>cluster-phones :  Cluster phones (or sets of phones) into sets for various purposes.</strong> e.g.: <strong>cluster-phones 1.tacc phonesets.txt questions.txt</strong></li>
<li><strong>compile-questions :</strong> e.g.: <strong>compile-questions questions.txt questions.qst</strong></li>
<li><strong>build-tree: Train decision tree.</strong> e.g.: <strong>build-tree treeacc roots.txt 1.qst topo tree</strong>

<ol>
<li>注意，我们在建立决策树时，是对每个音素的每个状态都建立一个决策树，而不是只对某一个音素来建立。
-<img src="http://10.0.1.215/markdown/kaldi_decisiontree.png" alt=""/></li>
<li>题集都是根据声学和语音学特征提出来的</li>
<li>如上就完成了参数绑定</li>
</ol></li>
<li><strong>gmm-init-model :</strong> Initialize GMM from decision tree and tree stats，<strong>注意，不同于 gmm-init-nomo</strong></li>
<li><strong>gmm-mixup :</strong> Does GMM mixing up (and Gaussian merging)，重新确定高斯数量</li>
<li><strong>convert-ali ：</strong> Convert alignments from one decision-tree/model to another。树变了，重新对齐</li>
</ol></li>
</ol></li>
<li><p>补充</p>

<ol>
<li>ark,s,cs:apply-cmvn

<ol>
<li>Read archive (sorted) from stdin。  “s” asserts archive is sorted, “cs” asserts  it will be called in sorted order. </li>
</ol></li>
<li><p>add-deltas  </p>

<ol>
<li>训练数据增加差分量，比如13维度mfcc处理后变成39维度</li>
<li>相对于 lda而言，两种feature格式之一</li>
<li><p>生成arpa就是 特定场景下，语言模型的先验概率</p>

<pre><code>    ```shell
    \data  
    ngram 1=nr # 一元语言模型  
    ngram 2=nr # 二元语言模型  
    ngram 3=nr # 三元语言模型  

    \1-grams:  
    pro_1 word1 back_pro1  

    \2-grams:  
    pro_2 word1 word2 back_pro2  

    \3-grams:  
    pro_3 word1 word2 word3  

    \end
    ```
</code></pre></li>
</ol></li>
<li><p>fstisstochastic  </p>

<ol>
<li>Checks whether an FST is stochastic and exits with success if so. Prints out maximum error (in log units).</li>
<li>保持随机性在某方面,也就是说首先,对于 G,所有状态中最小和最大的, 以及这些状态的出弧概率与最后的概率的和。这是我们程序&quot;fstisstochastic&quot;能实现的。如果G是随机的,所有的这些数字就都是 1(从程序中看到是 0,因为我们在log空间中执行的操作;这里是log半环)</li>
</ol></li>
<li><p>WFST(weighted finite-state transducer)相关</p>

<ol>
<li>Composition

<ol>
<li>WFST中最最重要的算法，它将两个不同级的WFST进行组合，举个例子，语音识别中发音词典的WFST是音素对词的映射，而语言模型的WFST是词对受语法约束的词的映射，那么两个WFST进行Composition后就变成了音素对受语法约束的词的映射。那么其实语音识别的WFST的最基本的框架也很简单，就是HCLG四个不同级的WFST进行依次Composition最后形成了HMM的状态对受语法约束的词的映射。</li>
</ol></li>
<li><p>epsilon removal</p>

<ol>
<li>epsilon removal是用来去除空转移（组合之后产生了一些空的状态转移，WFST中输入标签和输出标签都为空时才算）的操作，如果不进行这一步而直接进行determinzation的话也是可以的，因为我们把空符号当作一个regular的符号，但是这样的结果也不是确定的。
-<img src="http://10.0.1.215/markdown/fst_epsilon.png" alt=""/></li>
<li>结合上图的例子，0状态的epsilon closure是{1,2}，源状态就是0，对于1状态，它到3状态的转移为c不为空，则新生成的转移就是从0状态到3状态，标签为c，权重为0到1和1到3的权重相加（对tropical半环）；同样对2状态来说，它到4状态的转移为a不为空，到5状态的转移为b也不为空，则可以新生成两条转移，分别是0状态到4状态标签为a和0状态到5状态标签为b，权重也是累加。</li>
</ol></li>
<li><p>determinization</p>

<ol>
<li>最重要的优化操作，它可以大大地加快运行的时间，尤其对于语音识别这么庞大的系统，它是必不可少的。</li>
<li>当离开某个状态的转移上的输入标签相同时，采取某种机制只保留其中的一条而不影响整个系统的结果，这样离开某个状态的转移就是确定的了，因为每输入一个标签，它都会到达唯一一个确定的状态。
-<img src="http://10.0.1.215/markdown/fst_determinization.png" alt=""/></li>
<li>图（a）是一个基于tropical半环的WFSA，很明显它是不确定的，因为当输入a时既可以到达1状态又可以到达2状态；于是我们需要对它采取确定化操作，输入a时只保留一条转移，算法中采用了⨁操作，对于tropical半环就是取min值，所以这里保留权重为1的转移；到达状态是一个带残余权重（residual weight）的状态集合，如这里的（1,0）和（2,1），分别代表残余权重为0的状态1和残余权重为1的状态2，这个残余权重是必要的，因为它记录了之前被删除的那条权重为2的转移的信息，而且在后面的操作中还要继续传递，如后面的d/7转移（原来是d/6）。</li>
</ol></li>
<li><p>weight pushing</p>

<ol>
<li>形象的说，是从后向前，把权重推到前面</li>
<li>在很多序列识别的问题中我们都是通过找到最小的cost来解决问题的，那么在WFST中我们同样就是通过找到最大或者最小的权重路径来解决问题的。 而pushing后权重都集中在前面可以降低整体的搜索时间因为我们会一步步的把我们不需要的路径排除掉，这样一开始就可以排除掉了很多种可能路径。</li>
</ol></li>
<li><p>minimization</p>

<ol>
<li>让WFST中的状态数最少，效果图如下所示
-<img src="http://10.0.1.215/markdown/fst_minimization.png" alt=""/></li>
<li>左图是push weight后的结果，可以看出状态3和状态4到状态5的转移路径完全相同，所以可以把它们融合为一个状态（权重推移前是不等价的，故可以看出权重推移的必要性），右图是minimization后的结果</li>
</ol></li>
</ol></li>
</ol></li>
</ol></li>
<li><p>构建解码图</p>

<ol>
<li><strong>utils/mkgraph.sh  --mono data/lang_test_tg exp/mono0a exp/mono0a/graph_tgpr</strong>

<ol>
<li>构建解码图，解码图依赖于WFST（有限加权状态机）和数据的一系列处理</li>
<li>一个标准的WFST由四个模块构成：HCLG

<ol>
<li>H： HMM结构</li>
<li>C：音素的上下文依赖（context）</li>
<li>L：词典（lexicon）</li>
<li>G：grammar 也就是语言模型 LM，此处为之前训练脚本中prepare_lm.sh生成的 G.fst</li>
</ol></li>
<li>依次整合这四个，步骤如下

<ol>
<li><strong>fsttablecompose \(lang/L\_disambig.fst \)lang/G.fst | fstdeterminizestar --use-log=true | fstminimizeencoded | fstpushspecial |  fstarcsort --sort_type=ilabel &gt; $lang/tmp/LG.fst || exit 1;</strong><br/>
<strong>fstisstochastic $lang/tmp/LG.fst || echo&quot;[info]: LG not stochastic.&quot;</strong><br/>
先整合L和G，把每个词扩展成音素，然后determinize和minimize，我理解这里是类似决策树的建树、聚类间共享。</li>
<li>fstcomposecontext --context-size=$N --central-position=$P   --read-disambig-syms=$lang/phones/disambig.int   --write-disambig-syms=$lang/tmp/disambig_ilabels_${N}_${P}.int   $lang/tmp/ilabels_${N}_${P} &lt; $lang/tmp/LG.fst |  fstarcsort --sort_type=ilabel &gt; $clg<br/>
fstisstochastic $clg || echo &quot;[info]: CLG not stochastic.&quot;<br/>
这里加入C，把LG整合成CLG</li>
<li>make-h-transducer  --disambig-syms-out=$dir/disambig_tid.int   --transition-scale=$tscale $lang/tmp/ilabes_${N}_${P} $tree $model   &gt; $dir/Ha.fst || exit 1;<br/>
构成H传感器，Ha.fst 就是H.fst，这是不包含 self-loops<br/>
如果是triphone，包含在如ilables_3_1这样的文件里</li>
<li>fsttablecompose $dir/Ha.fst &quot;$clg&quot; | fstdeterminizestar --use-log=true  | fstrmsymbols $dir/disambig_tid.int | fstrmepslocal |   fstminimizeencoded &gt; $dir/HCLGa.fst || exit 1;
fstisstochastic $dir/HCLGa.fst || echo &quot;HCLGa is not stochastic&quot;<br/>
把Ha.fst合并到CLG.fst，删除symbols</li>
<li>add-self-loops  --self-loop-scale=$loopscale --reorder=true   $model &lt; $dir/HCLGa.fst &gt; $dir/HCLG.fst || exit 1;</li>
</ol></li>
</ol></li>
</ol></li>
<li><p>解码  steps/decode.sh</p>

<ol>
<li>脚本里包含了对现有feature格式的判断，feature有两种，通过判断输入是否存在final.mat ，来指定feature type是 deltas还是lda，如果是lda类型，需要将feature进行拼接和转换

<ol>
<li>delta+delta-delta
-<img src="http://10.0.1.215/markdown/kaldi_window.png" alt=""/>
MFCC过程中，一个窗口抽出13维倒谱系数，最后delta+delta-delta计算了当前特征和前一个特征，因此总的维度(矩阵列数，在HMM的topo中体现）是13+13+13=39</li>
<li>LDA+MLLT(Maximum Likelihood Linear Transform)  通过脚本 train_sat.sh(Speaker Adapted Training) 体现，多用于speaker的自适应训练<br/>
LDA 主要用来降维度， MLLT用作基础的线性转换
-<img src="http://10.0.1.215/markdown/kaldi_feature.png" alt=""/></li>
</ol></li>
<li>$cmd --num-threads $num_threads JOB=1:$nj $dir/log/decode.JOB.log gmm-latgen-faster $thread_string --max-active=$max_active --beam=$beam --lattice- beam=$lattice_beam --acoustic-scale=$acwt --allow-partial=true --word-symbol-table=$graphdir/words.txt $model $graphdir/HCLG.fst &quot;$feats&quot; &quot;ark:|gzip -c &gt; $dir/lat.JOB.gz&quot; || exit 1;<br/>

<ol>
<li><strong>gmm-latgen-faster</strong> 用来对测试集或者说是预测集做评估。他给每个utterance生成一个word层级的lattice，选出最好的，通过WER(WordErrorRate)评估

<ol>
<li>--max-active Decoder的最大活跃状态数</li>
<li><strong>--acoustic-scale</strong>  acoustic likelihoods的缩放因子，这个还不知道怎么用</li>
<li>--allow-partial=true  允许在没到达结束状态时的结果，或许可以理解成局部最优？</li>
<li>输入 words.txt  HCLG.fst feature  输出 lat.JOB.gz</li>
</ol></li>
<li><strong>beam</strong> 用在计算Viterbi过程中的剪枝操作，避免诸如维灾难的情况，影响所有utterance的decoding速度</li>
<li><strong>max-active-states</strong> 是在遇到有样本噪声的情况，最坏情况下的阈值，同样可以降低冗余计算量</li>
<li><strong>lattice-beam</strong> 影响的是生成lattice的解析速度</li>
<li><strong>steps/diagnostic/analyze_lats.sh</strong>

<ol>
<li><strong>lattice-depth-per-frame</strong>

<ol>
<li>对于每个lattice，计算每个frame的深度(depth_tmp.JOB.gz)，也就是arcs，保存在一个vector里</li>
</ol></li>
<li><strong>lattice-best-path</strong>

<ol>
<li>生成lattice的1-best路径，并生成一个临时的对齐ali_tmp.JOB.gz

<ol>
<li>注意，如果要输出FSTs 用 lattice-1best，如果要输出LM的得分，用 <strong>lattice-1best | nbest-to-linear</strong></li>
</ol></li>
</ol></li>
<li><strong>ali-to-phones</strong>

<ol>
<li>把model-level的对齐 ali_tmp.JOB.gz 转化成音素的序列（phone-sequences) </li>
</ol></li>
<li>把depth_tmp.JOB.gz 和音素序列合并，生成depth_stats_tmp.JOB.gz</li>
<li><strong>tonsteps/diagnostic/analyze_lattice_depth_stats.py分析 depth_stats_tmp.JOB.gz</strong></li>
</ol></li>
<li>local/score.sh</li>
</ol></li>
</ol></li>
<li><p>align_si.sh</p>

<ol>
<li>判断feature的类型（通过final.mat），并对特征进行转换</li>
<li><strong>compile-train-graphs</strong> 重新生成训练图</li>
<li><strong>gmm-align-compiled</strong> 对齐，这里输入是模型，而align-equal-compiled的输入是fst，在模型之前。同时跟进变化的feature</li>
</ol></li>
<li><p><strong>steps/train_lda_mllt.sh</strong></p>

<ol>
<li><strong>ali-to-post</strong>  将对齐转化为后验，但是生成的Posterior 对象很细小, 每帧都有一个单元后验的 transition-id</li>
<li><strong>weight-silence-post</strong>  修改后验,通常用于减小静音的权重</li>
<li><strong>acc-lda</strong> Accumulate LDA statistics based on pdf-ids.   <strong>只计算一次</strong></li>
<li>**est-lda ** Estimate LDA transform using stats obtained with acc-lda. 生成一个0.mat</li>
<li><strong>gmm-init-model-flat</strong> Initialize GMM, with Gaussians initialized to mean and variance of some provided example data （在三音素未build-tree的时候调用）</li>
<li><strong>gmm-acc-mllt</strong> Accumulate MLLT (global STC) statistics   <strong>每次迭代都计算</strong></li>
<li><strong>est-mllt</strong> Do update for MLLT (also known as STC)</li>
<li><strong>gmm-transform-means</strong> Transform GMM means with linear or affine transform</li>
<li><strong>compose-transforms</strong> Compose (affine or linear) feature transforms。每个迭代更新*.mat，体现在feats中

<ol>
<li>feats=&quot;\(splicedfeats transform-feats \)dir/0.mat ark:- ark:- |&quot;</li>
</ol></li>
</ol></li>
<li><p><strong>steps/train_sat.sh</strong> This does Speaker Adapted Training (SAT) It can be done on top of either LDA+MLLT, or delta and delta-delta features.</p>

<ol>
<li>通常语音识别系统的应用环境与训练语料具有不同程度的不匹配性，因此，往往需要进行一定的声学模型自适应，以得到比较好的识别效果。</li>
<li>通常就是fmmlr技术，LDA+MLLT</li>
<li>gmm-est-fmllr

<ol>
<li>fmllr 特征空间的极大似然线性回归</li>
<li>Estimate global fMLLR transforms, either per utterance or for the supplied set of speakers (spk2utt option)</li>
</ol></li>
<li>gmm-acc-stats-twofeats

<ol>
<li>Accumulate stats for GMM training, computing posteriors with one set of features but accumulating statistics with another.First features are used to get posteriors, second to accumulate stats</li>
<li>第一个特征是计算后验的，也就是经过mllr转换的<br/>
第二个计算acc，通过speaker-independent feature，也就是未经mllr转换的feature</li>
</ol></li>
</ol></li>
<li><p><strong>steps/</strong><strong>align_fmllr.sh</strong></p>

<ol>
<li>gmm-post-to-gpost:  Convert state-level posteriors to Gaussian-level posteriors</li>
<li>gmm-est-fmllr-gpost: Estimate global fMLLR transforms, either per utterance or for the supplied set of speakers (spk2utt option). Reads Gaussian-level posteriors.  Writes to a table of matrices.</li>
</ol></li>
<li><p>steps/train_ubm.sh</p>

<ol>
<li>ubm（广义背景模型）是在SGMM建模中训练满协方差的模型，这个模型作为初始化模型，再去训练SGMM</li>
<li>sgmm 子空间高斯混合模型，每个状态依然对应一个混合高斯函数，只是该函数的均值、方差、权重通过一个向量，分别和均值方差权重的映射矩阵计算得到，该向量与当前状态有关，感觉像投影降维，把特征打平，模型参数变得更紧凑。而参数的映射矩阵则为所有状态共享，这些参数能通过所有的训练数据进行更新，这使得在有限的训练数据下，模型参数能够得到更充分的训练。</li>
<li><strong>init-ubm</strong>

<ol>
<li>Cluster the Gaussians in a diagonal-GMM acoustic model to a single full-covariance or diagonal-covariance GMM.</li>
<li>把之前的alidir/final.mdl 转换成 0.ubm</li>
</ol></li>
<li><strong>gmm-gselect</strong>

<ol>
<li>Precompute Gaussian indices for pruning (e.g. in training UBMs, SGMMs, tied-mixture systems) For each frame, gives a list of the n best Gaussian indices,
 sorted from best to worst.</li>
</ol></li>
<li><strong>fgmm-global-to-gmm</strong>

<ol>
<li>Convert single full-covariance GMM to single diagonal-covariance GMM.</li>
</ol></li>
<li><strong>fgmm-global-est</strong>

<ol>
<li> Estimate a full-covariance GMM from the accumulated stats.</li>
</ol></li>
<li>迭代生成final.ubm</li>
</ol></li>
<li><p><strong>steps/train_sgmm2.sh</strong></p></li>
<li><p><strong>steps/align_sgmm2.sh</strong></p></li>
<li><p><strong>steps/make_denlats_sgmm2.sh</strong></p></li>
<li><p><strong>steps/train_mmi_sgmm2.sh</strong></p>

<ol>
<li>加入最大互信息，解决模型辨别能力不强的问题。原因是，通过Baum-Welch算法计算似然概率，只会计算标记为该模型的训练数据，不排除计算其他模型的训练数据的时候，似然概率也很大，也就是范化能力弱。</li>
</ol></li>
<li><p><strong>steps/nnet/make_fmllr_feats.sh</strong></p>

<ol>
<li>第一步在mfcc特征基础上做fmllr变换，然后我们用的是这个特征。</li>
<li>feature 中，通过feature_type 进行 transform设定</li>
<li>然后copy-feats进行转换，然后merge</li>
</ol></li>
<li><p>**utils/subset_data_dir_tr_cv.sh ** \(dir \){dir}_tr90 ${dir}_cv10</p>

<ol>
<li>90%用来训练，10%用来做交叉。</li>
</ol></li>
<li><p>steps/nnet/pretrain_dbn.sh</p>

<ol>
<li>DBN预训练是通过CD-1（对比散度）来做的。用神经网络的形式对特征变换，dbn的输入时0均值和单元方差，使用分块和shift+scale来做的。</li>
<li>注意：第一层是Gaussian-Bernoulli RBM，后面的几层是Bernoulli-Bernoulli RBMs。</li>
<li>对特征的处理，然后求cmvn和add deltas，然后送到特征变换里</li>
<li>创建一个&#39;feature_transform&#39; 在NN之前：

<ol>
<li>初始化feature_transform_proto</li>
<li>nnet-initialize，通过proto初始化成nnet.init</li>
<li><strong>nnet-forward 向后传播</strong></li>
<li><strong>compute-cmvn-stats 计算向后传播的cmvn-g.stats</strong></li>
<li><strong>cmvn-to-nnet 把cmvn等参数重新转换为nnet里的参数</strong></li>
<li><strong>nnet-concat</strong>把nnet.init和上一步结果连接起来</li>
</ol></li>
<li>以网络深度迭代x：

<ol>
<li>第一个迭代特殊处理，因为输入节点是高斯分布

<ol>
<li><strong>nnet-initialize</strong></li>
<li><strong>rbm-train-cd1-frmshuff  通过CD和一阶CMCM 训练rbm（可以设置迭代次数、数据子集）</strong>

<ol>
<li>区别： —feature-transform 是之前计算的feature_transform</li>
</ol></li>
<li><strong>rbm-convert-to-nnet  生成dbn</strong></li>
</ol></li>
<li>其余迭代是伯努利分布，可以迭代计算

<ol>
<li>计算cmvn

<ol>
<li><strong>nnet-forward  输入是上个迭代的dbn和feature_transform连起来</strong></li>
<li><strong>compute-cmvn-stats</strong></li>
<li><strong>cmvn-to-nnet → x.cmvn</strong></li>
</ol></li>
<li>基于计算的x.cmvn生成proto</li>
<li><strong>nnet-initialize proto → rbm.init</strong></li>
<li><strong>rbm-train-cd1-frmshuff rbm.init  → x.rbm</strong>

<ol>
<li>区别：—feature_transform是之前的feature_transform和上个迭代的x-1.dbn联合起来</li>
</ol></li>
<li>**nnet-concat **

<ol>
<li>****rbm-convert-to-nnet  <strong>x.rbm 合并 上个迭代的dbn → x.dbn</strong></li>
</ol></li>
</ol></li>
</ol></li>
</ol></li>
<li><p><strong>steps/nnet/train.sh   帧交叉熵训练</strong></p>

<ol>
<li>和上面类似，只是训练的时候用<strong>steps/nnet/train_scheduler.sh</strong>

<ol>
<li>**nnet-train-frmshuff   **Usage:  ***<strong><em>$0</em></strong>* <mlp-init> <feats-tr> <feats-cv> <labels-tr> <labels-cv> <exp-dir>**</li>
<li>label 和 feats用 **ali-to-pdf  <strong>ali-to-post 等生成</strong>**</li>
</ol></li>
</ol></li>
<li><p>steps/nnet/decode.sh </p>

<ol>
<li><strong>nnet-initialize copy_and_softmax.nnet</strong></li>
<li>_<strong>nnet</strong>_<strong>-concat  softmax.net (<a href="http://softmax.net/">http://softmax.net/</a>) 和final.net合并</strong></li>
<li>_<strong>nnet</strong>_**-forward | <strong>latgen-faster-mapped → lat.JOB.gz (reuse HCLG.fst)</strong>**</li>
</ol></li>
<li><p>steps/nnet/train_mpe.sh  make_denlats.sh</p>

<ol>
<li>对所有utterance联合优化来训练网络</li>
<li>使用每句迭代的随机梯度下降法</li>
<li>sMBR的目标是最大化从参考的对齐中得到的状态标签的期望正确率</li>
<li><strong>nnet-train-mpe-sequential</strong></li>
</ol></li>
<li><p>steps/nnet/decode 和之前一样</p></li>
<li><p>评分 <strong>local</strong><strong>/score.sh</strong></p>

<ol>
<li>lattice-scale --inv-acoustic-scale=LMWT &quot;ark:gunzip -c $dir/lat.*.gz|

<ol>
<li>从decode.sh 中的<strong>gmm-latgen-faster</strong>生成的lattice读取，通过一个2x2的矩阵， 对lattice的权重概率进行缩放</li>
</ol></li>
<li>lattice-add-penalty --word-ins-penalty=$word_ins_penalty ark:- ark:-

<ol>
<li>给lattice增加word的插入惩罚系数，该系数是log以e为底的负数，也就是ln，添加到language model的cost中</li>
</ol></li>
<li>lattice-best-path --word-symbol-table=$symtab

<ol>
<li>通过lattices选出1-best路径，输出就是utterance-id 和识别结果，此时的结果为word对应的int</li>
<li>word-symbol-table就是之前的word.txt</li>
</ol></li>
<li>utils/int2sym.pl -f 2- $symtab | sed &#39;s:&lt;UNK&gt;::g&#39; |

<ol>
<li>把word转换为字面</li>
</ol></li>
<li>compute-wer  --text --mode=present

<ol>
<li>计算WER</li>
</ol></li>
</ol></li>
<li><p>对align操作的理解</p>

<ol>
<li>在Kaldi提供的例子中，大部分语料库都不标注语素的时间信息，因此必须通过一些基本原则进行时间对准，因此用到了上面提到的Viterbi算法搜索出最优路径， 并强制对齐，包括了词需要转换成哪些因素，以及每个因素所对应的帧</li>
</ol></li>
<li><p>对齐生成结果文件”ali”的理解</p>

<ol>
<li>show-alignments data/lang/phones.txt exp/mono0a/40.mdl &quot;ark:gunzip -c exp/mono0a/ali.1.gz|&quot; | head -1，这个是yesno的例子，结果如下：
-<img src="http://10.0.1.215/markdown/kaldi_ali.png" alt=""/></li>
<li>这里第一列代表的是utterance-id， 后面每一个【】都代表一个音素，里面的数字代表的是状态转移id(transition-id)，状态id是依据phones.txt中的音素依次向后递增的，如下，圆圈内就是状态，箭头代表转台转移，也就是【】中的数字，状态个数在HMM的topo中指定。
-<img src="http://10.0.1.215/markdown/kaldi_state.png" alt=""/></li>
</ol></li>
<li><p>对生成fst文件的理解</p>

<ol>
<li>compile-train-graphs exp/mono0a/tree exp/mono0a/0.mdl data/lang/L.fst &#39;ark:sym2int.pl --map-oov 1 -f 2- data/lang/words.txt &lt; data/train_yesno/split1/1/text|&#39; &#39;ark:|gzip -c &gt; exp/mono0a/fsts.1.gz&#39;

<ol>
<li>这个是为每一个句子生成一个fst，来更好的align</li>
</ol></li>
<li>sym2int.pl --map-oov 1 -f 2- data/lang/words.txt &lt; data/train_yesno/split1/1/text

<ol>
<li>这句就是把text里的音素对应成数字，把oov词映射成1.
-<img src="http://10.0.1.215/markdown/kaldi_sym2int.png" alt=""/></li>
</ol></li>
<li>L.fst : fstprint --isymbols=data/lang/phones.txt --osymbols=data/lang/words.txt data/lang/L.fst

<ol>
<li>本质上就是fst格式的lexicon，输入时phones，输出是word
-<img src="http://10.0.1.215/markdown/kaldi_L.fst.png" alt=""/><br/>
左后一列应该是概率之类的</li>
</ol></li>
<li>fsts.1.gz : fstcopy &#39;ark:gunzip -c exp/mono0a/fsts.1.gz|&#39; ark,t:- | head
-<img src="http://10.0.1.215/markdown/kaldi_fsts.gz.png" alt=""/> 

<ol>
<li>前三列是转移id，其中，前两列是按照句子的第一个音素开始计数的，而第三列是根据phones.txt对应的顺序来计数的。第四列是word.txt里所对应的int。0表示没有词对应，kaldi里用<eps>来表示。第五列是cost，这里都是相同的。</li>
<li>compile-train-graph是不考虑转移概率的，因为在一开始训练的时候，计算转移概率是多余的，我们把音素对应的帧对应出来之后再计算会方便很多。</li>
</ol></li>
</ol></li>
<li><p>lattice</p>

<ol>
<li>A lattice is a representation of the alternative word-sequences that are &quot;sufficiently likely&quot; for a particular utterance. </li>
</ol></li>
</ol>

<h2 id="toc_1">二、主要训练流程</h2>

<ol>
<li><p>train-mono.sh</p>

<ol>
<li>gmm-init-mono: top → 0.mdl  tree</li>
<li>compile-train-graphs:  tree 0.mdl L.fst → fst.JOB.gz</li>
<li>align-equal-compiled: fsts.JOB.gz feature  |  gmm-acc-stats-ali: 0.mdl feature → 0.JOB.acc</li>
<li>gmm-est: 0.*.acc → 1.mdl</li>
<li>1.mdl → final.mdl</li>
</ol></li>
<li><p>mkgraph.sh</p>

<ol>
<li>L_disambig.fst G.fst tree final.mdl → HCLG.fst</li>
</ol></li>
<li><p>steps/decode.sh<br/>
    1. gmm-latgen-faster: final.mdl HCLG.fst feature → lat.JOB.gz<br/>
    2. local/score.sh</p></li>
<li><p>steps/align_si.sh</p>

<ol>
<li>compile-train-graphs</li>
<li>gmm-align-compiled:  final.mdl fst.JOB.gz feature → ali.JOB.gz</li>
</ol></li>
<li><p>steps/train_deltas.sh</p>

<ol>
<li>acc-tree-stats: final.mdl feature ali.JOB.gz → JOB.treeacc</li>
<li>sum-tree-stats:  *.treeacc → treeacc</li>
<li>cluster-phones:  treeacc phones/set.int → questions.int</li>
<li>compile-questions: topo questions.int → questions.qst</li>
<li>build-tree:  treeacc phones/roots.txt questions.qst topo → tree</li>
<li>gmm-init-model:  tree treeacc topo  → 1.mdl 1.occs</li>
<li>gmm-mixup:  1.mdl 1.occs → 1.mdl </li>
<li>convert-ali:  final.mdl 1.mdl tree ali.JOB.gz  → ali.JOB.gz</li>
<li>compile-train-graphs:  tree 1.mdl L.fst → fst.JOB.gz</li>
<li>迭代x：

<ol>
<li>gmm-align-compiled:  x.mdl fst.JOB.gz  → ali.JOB.gz (指定的某些迭代中对齐）</li>
<li>gmm-acc-stats-ali:  x.mdl feature ali.JOB.gz  → x.JOB.acc</li>
<li>gmm-est:  x.JOB.acc x.mdl → (x+1).mdl (x+1).occs</li>
</ol></li>
<li>x.mdl → final.mdl</li>
<li>x.occs → final.occs</li>
</ol></li>
<li><p>mkgraph.sh &amp;&amp; steps/decode.sh</p></li>
<li><p>steps/align_si.sh</p></li>
<li><p>steps/train_lda_mllt.sh</p>

<ol>
<li> ali-to-post:  ali.JOB.gz | weight-silence-post:  final.mdl | acc-lda:  final.mdl feature_without_transform → lda.JOB.acc</li>
<li>est-lda: lda.*.acc → 0.mat full.mat</li>
<li>acc-tree-stats:  final.mdl feature ali.JOB.gz → JOB.treeacc</li>
<li>sum-tree-stats:  *.treeacc → treeacc</li>
<li>cluster-phones:  treeacc phones/set.int → questions.int</li>
<li>compile-questions: topo questions.int → questions.qst</li>
<li>build-tree:  treeacc phones/roots.txt questions.qst topo → tree</li>
<li>gmm-init-model:  tree treeacc topo  → 1.mdl 1.occs</li>
<li>convert-ali:  final.mdl 1.mdl tree ali.JOB.gz  → ali.JOB.gz（到这里跟之前的train_deltas差不多，只是没有mixup了）</li>
<li>compile-train-graphs:  tree 1.mdl L.fst → fst.JOB.gz</li>
<li>迭代x:

<ol>
<li>gmm-align-compiled:  x.mdl fst.JOB.gz  feature_with_transform（feature中包含了对0.mat的转换） → ali.JOB.gz (指定的某些迭代中对齐）</li>
<li>ali-to-post:  ali.JOB.gz | weight-silence-post:  x.mdl | gmm-acc-mllt:  x.mdl feature_with_transform → x.JOB.macc</li>
<li>est-mllt:  x.*.macc → x.mat.new</li>
<li>gmm-transform-means:  x.mat.new x.mdl → x.mdl</li>
<li>compose-transforms:  x.mat.new last.mat → x.mat</li>
<li>在feature中 把last.mat 更新为x.mat</li>
<li>gmm-acc-stats-ali:  x.mdl feature_with_transform ali.JOB.gz  → x.JOB.acc</li>
<li>gmm-est:  x.JOB.acc x.mdl → (x+1).mdl (x+1).occs</li>
<li>x.mdl → final.mdl</li>
<li>x.occs → final.occs</li>
<li>x.mat → final.mat</li>
</ol></li>
</ol></li>
<li><p>steps/align_si.sh</p></li>
<li><p>steps/train_sat.sh</p>

<ol>
<li>ali-to-post:  ali.JOB.gz | weight-silence-post:  final.mdl | gmm-est-fmllr:  final.mdl feature_without_transform → trans.JOB</li>
<li>acc-tree-stats:  final.mdl feature ali.JOB.gz → JOB.treeacc</li>
<li>sum-tree-stats:  *.treeacc → treeacc</li>
<li>cluster-phones:  treeacc phones/set.int → questions.int</li>
<li>compile-questions: topo questions.int → questions.qst</li>
<li>build-tree:  treeacc phones/roots.txt questions.qst topo → tree</li>
<li>gmm-init-model:  tree treeacc topo  → 1.mdl 1.occs</li>
<li>convert-ali:  final.mdl 1.mdl tree ali.JOB.gz  → ali.JOB.gz</li>
<li>compile-train-graphs:  tree 1.mdl L.fst → fst.JOB.gz</li>
<li>迭代x:

<ol>
<li>gmm-align-compiled:  x.mdl fst.JOB.gz  feature_with_transform（feature中包含了对trans.JOB的转换） → ali.JOB.gz (指定的某些迭代中对齐）</li>
<li>ali-to-post:  ali.JOB.gz | weight-silence-post:  x.mdl | gmm-est-fmllr: x.mdl feature_with_transform → tmp_trans.JOB</li>
<li> compose-transforms： tmp_trans.JOB trans.JOB → trans.JOB</li>
<li>更新feature中的 trans.JOB</li>
<li>gmm-acc-stats-ali:  x.mdl feature_with_transform ali.JOB.gz → x.JOB.acc</li>
<li>gmm-est:  x.JOB.acc  x.mdl → (x+1).mdl (x+1).occs</li>
</ol></li>
<li>ali-to-post:  ali.JOB.gz |  gmm-acc-stats-two-feats:  x.mdl feature_with_transform feature_without_transform → x.JOB.acc</li>
<li>gmm-est: x.mdl  x.JOB.acc  → x.alimdl</li>
<li>x.mdl → final.mdl </li>
<li>x.occs → final.occs</li>
<li>x.alimdl → final.alimdl</li>
</ol></li>
<li><p>steps/decode_fmllr.sh</p>

<ol>
<li>mkgraph.sh &amp;&amp; steps/decode.sh</li>
<li>gunzip:  lat.JOB.gz | lattice-to-post |  weight-silence-post:  final.alimdl | gmm-post-to-gpost:  final.alimdl feature | gmm-est-fmllr-gpost:  final.mdl feature → pre_trans.JOB</li>
<li>更新feature 加入 transform和 pre_trans.JOB</li>
<li>gmm-latgen-faster:  final.mdl HCLG.fst feature → lat.tmp.JOB.gz</li>
<li>lattice-determinize-pruned:  lat.tmp.JOB.gz | lattice-to-post:  final.mdl | gmm-est-fmllr final.mdl feature → trans_tmp.JOB</li>
<li>compose-transforms:  trans_tmp.JOB pre_trans.JOB → trans.JOB</li>
<li>更新feature 加入transform 和 trans.JOB</li>
<li>gmm-rescore-lattice:  final.mdl lat.tmp.JOB.gz feature | lattice-determinize-pruned  → lat.JOB.gz</li>
<li>local/score.sh</li>
</ol></li>
<li><p>steps/align_fmllr.sh</p>

<ol>
<li>compile-train-graphs:  tree final.mdl L.fst → fsts.JOB.gz</li>
<li>gmm-align-compiled:  final.alimdl  fsts.JOB.gz  feature  → pre_ali.JOB.gz</li>
<li>ali-to-post:  pre_ali.JOB.gz | weight-silence-post:  final.alimdl   |  gmm-post-to-gpost:  final.alimdl feature | gmm-est-fmllr-gpost:  final.mdl feature → trans.JOB</li>
<li>更新feature 加入transform 和 trans.JOB</li>
<li>gmm-align-compiled:   final.mdl  fsts.JOB.gz feature_with_transform  → ali.JOB.gz</li>
</ol></li>
<li><p>steps/decode_fmllr.sh</p>

<ol>
<li>lattice-determinize-pruned

<ol>
<li>Determinize lattices, keeping only the best path (sequence of acoustic states)
for each input-symbol sequence.  This version does pruning as part of the
determinization algorithm, which is more efficient and prevents blowup.</li>
</ol></li>
<li> lattice-to-post

<ol>
<li> Do forward-backward and collect posteriors over lattices.</li>
<li>在预设模型M和观察序列O都确定的情况下，计算P(O|M)这个条件概率</li>
</ol></li>
<li>gmm-rescore-lattice

<ol>
<li>Replace the acoustic scores on a lattice using a new model.</li>
</ol></li>
</ol></li>
<li><p>steps/make_fbank.sh</p>

<ol>
<li>extract-segments

<ol>
<li>Extract segments from a large audio file in WAV format.</li>
</ol></li>
<li>compute-fbank-feats

<ol>
<li>Create Mel-filter bank (FBANK) feature files.</li>
</ol></li>
<li>copy-feats

<ol>
<li>Copy features [and possibly change format]</li>
</ol></li>
</ol></li>
<li><p>steps/compute_cmvn_stats.sh</p>

<ol>
<li>compute-cmvn-stats-two-channel    two-channel的情况，比如打电话场景</li>
<li>compute-cmvn-stats

<ol>
<li>Compute cepstral mean and variance normalization statistics</li>
</ol></li>
<li>modify-cmvn-stats     存在fake-dim的情况

<ol>
<li>Copy cepstral mean/variance stats so that some dimensions have &#39;fake&#39; stats that will skip normalization</li>
</ol></li>
</ol></li>
<li><p>steps/nnet/train.sh</p>

<ol>
<li>nnet-initialize

<ol>
<li>Initialize Neural Network parameters according to a prototype </li>
</ol></li>
<li>nnet-forward

<ol>
<li>Perform forward pass through Neural Network.</li>
<li>Usage: nnet-forward [options] <nnet1-in> <feature-rspecifier> <feature-wspecifier></li>
</ol></li>
<li>nnet-concat

<ol>
<li>Concatenate Neural Networks (and possibly change binary/text format)</li>
<li>Usage: nnet-concat [options] <nnet-in1> &lt;...&gt; <nnet-inN> <nnet-out></li>
</ol></li>
<li>cmvn-to-nnet

<ol>
<li>Convert cmvn-stats into <AddShift> and <Rescale> components.</li>
<li>Usage:  cmvn-to-nnet [options] <transf-in> <nnet-out></li>
</ol></li>
<li>utils/nnet/make_nnet_proto.py

<ol>
<li>Generated Nnet prototype, to be initialized by &#39;nnet-initialize&#39;.</li>
</ol></li>
<li>steps/nnet/train_scheduler.sh

<ol>
<li>Schedules epochs and controls learning rate during the neural network training</li>
</ol></li>
</ol></li>
<li><p>steps/nnet/decode.sh</p></li>
<li><p>steps/nnet/align.sh</p></li>
<li><p>steps/nnet/make_denlats.sh</p></li>
<li><p>steps/nnet/train_mpe.sh</p></li>
<li><p>steps/train_quick.sh</p>

<ol>
<li>和steps/train_sat.sh 内容类似，有一些差别：

<ol>
<li>利用之前的trans.JOB 不需要重新计算，而是直接建树</li>
<li>gmm-init-model 不是完全从头初始化，而是利用之前的final.mdl进行初始化</li>
<li>因为采用的是依靠其他模型初始化，之后增加了gmm-mixup步骤，来保证mix-down 和 mix-up的高斯数量和我们想要的是一致的</li>
<li>不需要fmllr转换</li>
<li>存在trans.1 的情况下，更新final.alimdl</li>
</ol></li>
</ol></li>
<li><p>steps/decode_fmllr.sh</p></li>
<li><p>steps/align_fmllr.sh (train)</p></li>
<li><p>steps/align_fmllr.sh (dev) cv</p></li>
<li><p>local/nnet/run_dnn.sh</p>

<ol>
<li>steps/make_fbank.sh

<ol>
<li>compute-fbank-feats:  wav.JOB.scp |  copy-feats → raw_fbank.JOB.ark,raw_fbank.JOB.scp</li>
<li>raw_fbank.JOB.ark → feats.scp</li>
</ol></li>
<li>steps/compute_cmvn_stats.sh

<ol>
<li>compute-cmvn-stats:  feats.scp → cmvn.ark, cmvn.scp</li>
</ol></li>
<li>steps/nnet/train.sh

<ol>
<li>ali-to-pdf:  alidir/final.mdl alidir/ali.*.gz  → PDF</li>
<li>analyze-counts:  PDF → ali_train_pdf.counts</li>
<li>copy-transition-model:  alidir/final.mdl → final.mdl </li>
<li>cp:  alidir/tree → tree</li>
<li>generate proto</li>
<li>nnet-initialize:  proto feature_transform         #NN之前的特征转换</li>
<li>feature_transform → feature_transform_old </li>
<li>nnet-forward:  feature_transform_old feature_10k |  compute-cmvn-stats  → cmvn-g.stats</li>
<li>nnet-concat:  feature_transform_old “cmvn-to-nnet cmvn-g.stats”  feature_transform</li>
<li>utils/nnet/make_nnet_proto.py → nnet.proto    #根据模型topo参数生成</li>
<li>nnet-initialize:  nnet.proto → nnet.init    #初始化NN</li>
<li>（可选）nnet-concat:  dbn nnet.init → nnet_dbn.init</li>
<li>steps/nnet/train_scheduler.sh 

<ol>
<li><mlp-init> <feats-tr> <feats-cv> <labels-tr> <labels-cv> <exp-dir>  → final.nnet</li>
</ol></li>
</ol></li>
<li>steps/nnet/decode.sh

<ol>
<li>nnet-initialize:  proto(softmax) → copy_and_softmax.nnet</li>
<li>nnet-forward:  fina.nnet feature | latgen-faster-mapped:  HCLG.fst → lat.JOB.gz</li>
<li>local/score.sh</li>
</ol></li>
<li>steps/nnet/align.sh

<ol>
<li>compile-train-graphs:  tree final.mdl L.fst  | align-compiled-mapped:  final.mdl feature_with_nnet_forward → ali.JOB.gz</li>
</ol></li>
<li>steps/nnet/make_denlats.sh

<ol>
<li>Create denominator lattices for MMI/MPE/sMBR training.</li>
<li>text | utils/sym2int.pl:  words.txt | utils/make_unigram_grammar.pl | fstcompile | fstarcsort → new/G.fst</li>
<li>utils/mkgraph.sh → dengraph</li>
<li>latgen-faster-mapped:   final.mdl dengraph/HCLG.fst feature_with_nnet_forward  → lat.store_separately_as_gz.scp *.gz</li>
<li>*.gz → lat.scp</li>
</ol></li>
<li>steps/nnet/train_mpe.sh

<ol>
<li>Sequence-discriminative MPE/sMBR training of DNN. 4 iterations (by default) of Stochastic Gradient Descent with per-utterance updates.</li>
<li>迭代x:

<ol>
<li>nnet-_train_-mpe-sequential:  (x-1).nnet[src/final.mdl] alidir/final.mdl feature_train.scp  alidir/ali.*.gz lat.scp → x.nnet</li>
</ol></li>
<li>x.nnet → final.nnet</li>
</ol></li>
<li>steps/nnet/decode.sh</li>
</ol></li>
</ol>


		</div>

		

	</article>
  
	<div class="pagination">
	
<a href="archives.html">Blog Archives</a>
	 
	    
	</div>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="%E7%AC%94%E8%AE%B0.html"><strong>笔记&nbsp;(3)</strong></a>
	        
	        
	        
	      </li>
	  
	      <li class="post">
	        <a href="%E6%97%A5%E5%BF%97.html"><strong>日志&nbsp;(3)</strong></a>
	        
	        
	        
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="14700365720801.html">HDFS集群配置、搭建、备份</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="14700365205842.html">Flume配置方案、源码修改</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="14700364668003.html">基于HTK的孤立词无监督识别</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="14700359952396.html">HDFS数据表Schema</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="14700356814047.html">基于HTK的孤立词有监督识别</a>
		      </li>
	     
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>



</body>
</html>